# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ZCAD

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

```
python zcad_tcp_client.py
# Connection timeout

python uzvipcclient.py ping
# Connection timeout
```

–ö–æ–º–∞–Ω–¥—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ ZCAD, –Ω–æ **–æ—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è** - —Ç–∞–π–º–∞—É—Ç —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥.

## üîç –ü—Ä–∏—á–∏–Ω–∞

ZCAD –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON –æ—Ç–≤–µ—Ç —Å –∑–∞–≤–µ—Ä—à–∞—é—â–∏–º —Å–∏–º–≤–æ–ª–æ–º –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ `\n`:
```json
{ "id" : "cmd-0001", "status" : "ok", "result" : "pong" }\n
```

Python –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ `sendall()`, –Ω–æ **–Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –∑–∞–ø–∏—Å–∏**. –ò–∑-–∑–∞ —ç—Ç–æ–≥–æ:
1. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å
2. ZCAD –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç
3. –ö–ª–∏–µ–Ω—Ç –∂–¥—ë—Ç –≤ —Ü–∏–∫–ª–µ `recv()` –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö
4. ZCAD –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (–∂–¥—ë—Ç —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–º–∞–Ω–¥)
5. –ö–ª–∏–µ–Ω—Ç –∂–¥—ë—Ç 30 —Å–µ–∫—É–Ω–¥ –∏ –ø–æ–ª—É—á–∞–µ—Ç —Ç–∞–π–º–∞—É—Ç

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å `sock.shutdown(socket.SHUT_WR)` –ø–æ—Å–ª–µ `sendall()` —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å **—Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å—å**, –æ—Å—Ç–∞–≤–∏–≤ —á—Ç–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–º:

```python
with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
    sock.settimeout(30)
    sock.connect((self.host, self.port))
    sock.sendall(request_json.encode('utf-8'))
    # –ó–∞–∫—Ä—ã–≤–∞–µ–º –∑–∞–ø–∏—Å—å —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç
    sock.shutdown(socket.SHUT_WR)  # <-- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
    
    response_data = b''
    while True:
        chunk = sock.recv(4096)
        if not chunk:
            break  # –°–µ—Ä–≤–µ—Ä –∑–∞–∫—Ä—ã–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        response_data += chunk
    
    response = json.loads(response_data.decode('utf-8'))
    return response
```

## üìÅ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### `server/zcad_tcp_client.py`
–°—Ç—Ä–æ–∫–∞ ~113:
```python
sock.sendall(request_json.encode('utf-8'))
sock.shutdown(socket.SHUT_WR)  # –î–æ–±–∞–≤–ª–µ–Ω–æ
```

### `widget/uzvipcclient.py`
–°—Ç—Ä–æ–∫–∞ ~110:
```python
sock.sendall(request_json.encode('utf-8'))
sock.shutdown(socket.SHUT_WR)  # –î–æ–±–∞–≤–ª–µ–Ω–æ
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

```bash
# –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ ping
cd c:\zcad\GristWidgets\server
..\python\python.exe zcad_tcp_client.py

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# ZCAD –¥–æ—Å—Ç—É–ø–µ–Ω! –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏–µ 10 —Å–ª—É—á–∞–π–Ω—ã—Ö –ª–∏–Ω–∏–π...
# –£—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: 12/12 –∫–æ–º–∞–Ω–¥

# –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ uzvipcclient
cd c:\zcad\GristWidgets\widget
..\python\python.exe uzvipcclient.py ping

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# {"id": "cmd-0001", "status": "ok", "result": "pong"}

# –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ random_lines
..\python\python.exe uzvipcclient.py random_lines 1000

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# Completed: Batch mode completed: 1000 primitives imported

# –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ Flask API
curl -X POST http://127.0.0.1:5000/api/zcad/ping

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# {"status":"ok","message":"ZCAD connected"}
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### socket.shutdown() vs socket.close()

- `socket.close()` - –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é (—á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å)
- `socket.shutdown(socket.SHUT_WR)` - –∑–∞–∫—Ä—ã–≤–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å—å**, —á—Ç–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º

### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å
2. –ö–ª–∏–µ–Ω—Ç –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å (`shutdown(SHUT_WR)`)
3. ZCAD –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω–µ—Ü –ø–æ—Ç–æ–∫–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
4. ZCAD –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
5. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –≤–µ—Å—å –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ `recv()` –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–∏—Ç –ø—É—Å—Ç–æ–π chunk (–∫–æ–Ω–µ—Ü —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
6. –ü–∞—Ä—Å–∏—Ç JSON –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

–î–ª—è –ø–∞–∫–µ—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ (`BEGIN_BATCH`/`END_BATCH`) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:

```python
self.connect()  # –°–æ–∑–¥–∞—ë–º –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
self._send_command('BEGIN_BATCH', use_persistent=True)
self._send_command('LINE', [...], use_persistent=True)  # –ú–Ω–æ–≥–æ —Ä–∞–∑
self._send_command('END_BATCH', use_persistent=True)
self.disconnect()  # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
```

–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ `shutdown()` **–Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è** –ø–æ—Ç–æ–º—É —á—Ç–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–∞–Ω–¥.
