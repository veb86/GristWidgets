<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BDTree Widget - –¢–µ—Å—Ç</title>
  <link rel="stylesheet" href="widget/BDTree/css/style.css">
  <style>
    body {
      background: #f0f2f5;
      padding: 20px;
    }
    .test-container {
      max-width: 800px;
      margin: 0 auto;
    }
    .test-controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .test-controls h2 {
      margin-bottom: 15px;
      font-size: 16px;
    }
    .control-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }
    .control-group label {
      font-weight: 500;
      min-width: 150px;
    }
    .control-group select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .control-group button {
      padding: 8px 16px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s;
    }
    .control-group button:hover {
      background: #2563eb;
    }
    .widget-wrapper {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .data-preview {
      margin-top: 20px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .data-preview h3 {
      margin-bottom: 10px;
      font-size: 14px;
      color: #666;
    }
    .data-preview pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow: auto;
      max-height: 300px;
      font-size: 12px;
    }
    .tree-stats {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }
    .stat-item {
      background: #f3f4f6;
      padding: 10px 15px;
      border-radius: 6px;
      text-align: center;
    }
    .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }
    .stat-label {
      font-size: 12px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–º -->
    <div class="test-controls">
      <h2>üß™ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–º</h2>

      <div class="control-group">
        <label for="selectedGroupSelect">–í—ã–±—Ä–∞–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞ (SYSTEM.value):</label>
        <select id="selectedGroupSelect">
          <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>
          <option value="1">1 - lighting (–û—Å–≤–µ—â–µ–Ω–∏–µ)</option>
          <option value="2">2 - protection (–ó–∞—â–∏—Ç–∞)</option>
          <option value="3">3 - cables (–ö–∞–±–µ–ª–∏)</option>
          <option value="4">4 - luminaires (–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏)</option>
          <option value="5">5 - lamps (–õ–∞–º–ø—ã)</option>
          <option value="6">6 - breakers (–ê–≤—Ç–æ–º–∞—Ç—ã)</option>
          <option value="999">999 - –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –≥—Ä—É–ø–ø–∞</option>
        </select>
        <button onclick="updateSelectedGroup()">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>

      <div class="tree-stats">
        <div class="stat-item">
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">–í—Å–µ–≥–æ —É–∑–ª–æ–≤</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-roots">0</div>
          <div class="stat-label">–ö–æ—Ä–Ω–µ–≤—ã—Ö</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-depth">0</div>
          <div class="stat-label">–ì–ª—É–±–∏–Ω–∞</div>
        </div>
      </div>
    </div>

    <!-- –í–∏–¥–∂–µ—Ç -->
    <div class="widget-wrapper">
      <div class="container">
        <header class="widget-header">
          <h2>–í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h2>
          <span id="selected-info" class="selected-info">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span>
        </header>

        <div id="message-container"></div>

        <div class="tree-container">
          <div id="tree-root" class="tree-root">
            <!-- –î–µ—Ä–µ–≤–æ –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
          </div>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö -->
    <div class="data-preview">
      <h3>üìä Device_groups</h3>
      <pre id="groups-preview"></pre>
    </div>

    <div class="data-preview">
      <h3>üìä SYSTEM</h3>
      <pre id="system-preview"></pre>
    </div>

    <div class="data-preview">
      <h3>üå≥ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–µ—Ä–µ–≤–∞</h3>
      <pre id="tree-preview"></pre>
    </div>
  </div>

  <script>
    // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    var testData = {
      Device_groups: [
        { id: 1, manualSort: 1, parent_id: 0, code: 'lighting', name: '–û—Å–≤–µ—â–µ–Ω–∏–µ' },
        { id: 2, manualSort: 2, parent_id: 0, code: 'protection', name: '–ó–∞—â–∏—Ç–∞' },
        { id: 3, manualSort: 3, parent_id: 0, code: 'cables', name: '–ö–∞–±–µ–ª–∏' },
        { id: 4, manualSort: 1, parent_id: 1, code: 'luminaires', name: '–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏' },
        { id: 5, manualSort: 2, parent_id: 1, code: 'lamps', name: '–õ–∞–º–ø—ã' },
        { id: 6, manualSort: 1, parent_id: 2, code: 'breakers', name: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–∏' }
      ],
      SYSTEM: [
        { id: 1, param: 'selectedGroupID', value: '1' }
      ]
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ
    var state = {
      deviceGroups: testData.Device_groups.slice(),
      systemParams: testData.SYSTEM.slice(),
      selectedGroupId: 1,
      expandedNodes: {}
    };

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    var elements = {
      selectedGroupSelect: document.getElementById('selectedGroupSelect'),
      selectedInfo: document.getElementById('selected-info'),
      treeRoot: document.getElementById('tree-root'),
      messageContainer: document.getElementById('message-container'),
      groupsPreview: document.getElementById('groups-preview'),
      systemPreview: document.getElementById('system-preview'),
      treePreview: document.getElementById('tree-preview'),
      statTotal: document.getElementById('stat-total'),
      statRoots: document.getElementById('stat-roots'),
      statDepth: document.getElementById('stat-depth')
    };

    // ========================================
    // –õ–æ–≥–∏–∫–∞ –¥–µ—Ä–µ–≤–∞
    // ========================================

    function buildTree() {
      var groups = state.deviceGroups;
      var childrenMap = {};

      groups.forEach(function(group) {
        childrenMap[group.id] = [];
      });

      groups.forEach(function(group) {
        var parentId = group.parent_id || 0;
        if (childrenMap.hasOwnProperty(parentId)) {
          childrenMap[parentId].push(group);
        } else {
          childrenMap[0] = childrenMap[0] || [];
          childrenMap[0].push(group);
        }
      });

      Object.keys(childrenMap).forEach(function(key) {
        childrenMap[key].sort(function(a, b) {
          return (a.manualSort || 0) - (b.manualSort || 0);
        });
      });

      function buildNode(group) {
        var node = {
          id: group.id,
          code: group.code || '',
          name: group.name || '',
          children: []
        };
        if (childrenMap[group.id]) {
          node.children = childrenMap[group.id].map(function(child) {
            return buildNode(child);
          });
        }
        return node;
      }

      return (childrenMap[0] || []).map(function(root) {
        return buildNode(root);
      });
    }

    function findNode(nodeId, nodes) {
      for (var i = 0; i < nodes.length; i++) {
        var node = nodes[i];
        if (node.id === nodeId) return node;
        if (node.children.length > 0) {
          var found = findNode(nodeId, node.children);
          if (found) return found;
        }
      }
      return null;
    }

    function getPathToNode(nodeId, nodes, path) {
      if (!path) path = [];
      for (var i = 0; i < nodes.length; i++) {
        var node = nodes[i];
        var currentPath = path.concat([node.id]);
        if (node.id === nodeId) return currentPath;
        if (node.children.length > 0) {
          var found = getPathToNode(nodeId, node.children, currentPath);
          if (found) return found;
        }
      }
      return null;
    }

    // ========================================
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
    // ========================================

    function escapeHtml(text) {
      if (!text) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function renderNode(node, level) {
      var hasChildren = node.children && node.children.length > 0;
      var isExpanded = state.expandedNodes[node.id] !== false;
      var isSelected = state.selectedGroupId === node.id;

      var toggleClass = 'tree-toggle';
      if (!hasChildren) toggleClass += ' leaf';
      else if (isExpanded) toggleClass += ' expanded';

      var contentClass = 'tree-node-content';
      if (isSelected) contentClass += ' selected';

      var iconChar = hasChildren ? 'üìÅ' : 'üìÑ';
      var countHtml = hasChildren ? '<span class="tree-node-count">' + node.children.length + '</span>' : '';

      var html = '<li class="tree-node" data-id="' + node.id + '">' +
        '<div class="' + contentClass + '">' +
          '<span class="' + toggleClass + '">' + (hasChildren ? '‚ñ∂' : '') + '</span>' +
          '<span class="tree-node-icon">' + iconChar + '</span>' +
          '<span class="tree-node-text">' +
            '<span class="tree-node-code">' + escapeHtml(node.code) + '</span>' +
            '<span class="tree-node-name">' + escapeHtml(node.name) + '</span>' +
          '</span>' +
          countHtml +
        '</div>';

      if (hasChildren) {
        var childrenClass = isExpanded ? 'tree-children' : 'tree-children collapsed';
        html += '<li class="tree-node-children"><ul class="' + childrenClass + '">';
        node.children.forEach(function(child) {
          html += renderNode(child, level + 1);
        });
        html += '</ul></li>';
      }

      html += '</li>';
      return html;
    }

    function renderTree() {
      var tree = buildTree();

      if (!tree || tree.length === 0) {
        elements.treeRoot.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üå≥</div><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p></div>';
        return;
      }

      var html = '<ul class="tree-root">';
      tree.forEach(function(node) {
        html += renderNode(node, 0);
      });
      html += '</ul>';

      elements.treeRoot.innerHTML = html;

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
      if (state.selectedGroupId) {
        var node = findNode(state.selectedGroupId, tree);
        if (node) {
          elements.selectedInfo.textContent = node.code + ' ‚Äî ' + node.name;
          elements.selectedInfo.classList.add('has-value');
        } else {
          elements.selectedInfo.textContent = '–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞';
          elements.selectedInfo.classList.remove('has-value');
        }
      } else {
        elements.selectedInfo.textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω–æ';
        elements.selectedInfo.classList.remove('has-value');
      }

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      elements.statTotal.textContent = state.deviceGroups.length;
      elements.statRoots.textContent = tree.length;

      function calcDepth(nodes, depth) {
        var max = depth;
        nodes.forEach(function(node) {
          if (node.children.length > 0) {
            var d = calcDepth(node.children, depth + 1);
            if (d > max) max = d;
          }
        });
        return max;
      }
      elements.statDepth.textContent = calcDepth(tree, 1);
    }

    // ========================================
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    // ========================================

    elements.treeRoot.addEventListener('click', function(event) {
      var toggle = event.target.closest('.tree-toggle');
      if (toggle && !toggle.classList.contains('leaf')) {
        event.stopPropagation();
        var treeNode = toggle.closest('.tree-node');
        var nodeId = parseInt(treeNode.dataset.id, 10);
        state.expandedNodes[nodeId] = !state.expandedNodes[nodeId];
        renderTree();
        return;
      }

      var nodeContent = event.target.closest('.tree-node-content');
      if (nodeContent) {
        var treeNode = nodeContent.closest('.tree-node');
        var nodeId = parseInt(treeNode.dataset.id, 10);
        state.selectedGroupId = nodeId;
        state.systemParams[0].value = String(nodeId);
        renderTree();
        updatePreview();
      }
    });

    function updateSelectedGroup() {
      var value = elements.selectedGroupSelect.value;
      state.selectedGroupId = value ? parseInt(value, 10) : null;
      state.systemParams[0].value = value || '';
      renderTree();
      updatePreview();
    }

    function updateInfo() {
      elements.selectedGroupSelect.value = state.selectedGroupId || '';
    }

    function updatePreview() {
      elements.groupsPreview.textContent = JSON.stringify(state.deviceGroups, null, 2);
      elements.systemPreview.textContent = JSON.stringify(state.systemParams, null, 2);
      elements.treePreview.textContent = JSON.stringify(buildTree(), null, 2);
    }

    // ========================================
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    // ========================================

    function init() {
      updateInfo();
      updatePreview();
      renderTree();
    }

    init();
  </script>
</body>
</html>
