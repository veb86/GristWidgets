<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BDTree Widget - –¢–µ—Å—Ç (jsTree)</title>
  
  <!-- jsTree CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
  <link rel="stylesheet" href="widget/BDTree/css/style.css">
  
  <style>
    body {
      background: #f0f2f5;
      padding: 20px;
    }
    .test-container {
      max-width: 800px;
      margin: 0 auto;
    }
    .test-controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .test-controls h2 {
      margin-bottom: 15px;
      font-size: 16px;
    }
    .control-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }
    .control-group label {
      font-weight: 500;
      min-width: 150px;
    }
    .control-group select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .control-group button {
      padding: 8px 16px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s;
    }
    .control-group button:hover {
      background: #2563eb;
    }
    .widget-wrapper {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .data-preview {
      margin-top: 20px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .data-preview h3 {
      margin-bottom: 10px;
      font-size: 14px;
      color: #666;
    }
    .data-preview pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow: auto;
      max-height: 300px;
      font-size: 12px;
    }
    .tree-stats {
      margin-top: 15px;
      display: flex;
      gap: 20px;
    }
    .stat-item {
      background: #f3f4f6;
      padding: 10px 15px;
      border-radius: 6px;
      text-align: center;
    }
    .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }
    .stat-label {
      font-size: 12px;
      color: #6b7280;
    }
    .tree-actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    .log-container {
      background: #1f2937;
      color: #10b981;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Consolas', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–º -->
    <div class="test-controls">
      <h2>üß™ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–º</h2>

      <div class="control-group">
        <label for="selectedGroupSelect">–í—ã–±—Ä–∞–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞ (SYSTEM.value):</label>
        <select id="selectedGroupSelect">
          <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>
          <option value="1">1 - lighting (–û—Å–≤–µ—â–µ–Ω–∏–µ)</option>
          <option value="2">2 - protection (–ó–∞—â–∏—Ç–∞)</option>
          <option value="3">3 - cables (–ö–∞–±–µ–ª–∏)</option>
          <option value="4">4 - luminaires (–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏)</option>
          <option value="5">5 - lamps (–õ–∞–º–ø—ã)</option>
          <option value="6">6 - breakers (–ê–≤—Ç–æ–º–∞—Ç—ã)</option>
          <option value="999">999 - –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –≥—Ä—É–ø–ø–∞</option>
        </select>
        <button onclick="updateSelectedGroup()">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>

      <div class="tree-stats">
        <div class="stat-item">
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">–í—Å–µ–≥–æ —É–∑–ª–æ–≤</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-roots">0</div>
          <div class="stat-label">–ö–æ—Ä–Ω–µ–≤—ã—Ö</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-depth">0</div>
          <div class="stat-label">–ì–ª—É–±–∏–Ω–∞</div>
        </div>
      </div>
      
      <div class="tree-actions">
        <button onclick="expandAll()">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
        <button onclick="collapseAll()">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
      </div>
      
      <div class="control-group" style="margin-top: 15px;">
        <label>–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:</label>
        <span id="last-save" style="color: #666;">‚Äî</span>
      </div>
    </div>

    <!-- –í–∏–¥–∂–µ—Ç -->
    <div class="widget-wrapper">
      <div class="container">
        <header class="widget-header">
          <h2>–í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h2>
          <span id="selected-info" class="selected-info">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span>
        </header>

        <div id="message-container"></div>

        <div class="tree-container">
          <div id="tree-root" class="tree-root">
            <!-- –î–µ—Ä–µ–≤–æ –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
          </div>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö -->
    <div class="data-preview">
      <h3>üìä Device_groups</h3>
      <pre id="groups-preview"></pre>
    </div>

    <div class="data-preview">
      <h3>üìä SYSTEM</h3>
      <pre id="system-preview"></pre>
    </div>

    <div class="data-preview">
      <h3>üìù –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π</h3>
      <div id="log-container" class="log-container">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π...</div>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- jsTree -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>

  <script>
    // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ - –∫–∞–∫ –≤ –≤–∞—à–µ–º Grist
    var testData = {
      Device_groups: [
        { id: 1, manualSort: 1, parent_id: 0, code: 'lighting', name: '–°–≤–µ—Ç–æ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞' },
        { id: 2, manualSort: 2, parent_id: 0, code: 'protection', name: '–ê–ø–ø–∞—Ä–∞—Ç –∑–∞—â–∏—Ç—ã' },
        { id: 3, manualSort: 3, parent_id: 0, code: 'cables', name: '–ö–∞–±–µ–ª–∏' },
        { id: 4, manualSort: 1, parent_id: 1, code: 'luminaires', name: '–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏' },
        { id: 5, manualSort: 2, parent_id: 1, code: 'lamps', name: '–õ–∞–º–ø—ã' },
        { id: 6, manualSort: 1, parent_id: 2, code: 'breakers', name: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–∏' }
      ],
      SYSTEM: [
        { id: 1, param: 'selectedGroupID', value: '' }
      ]
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ
    var state = {
      deviceGroups: testData.Device_groups.slice(),
      systemParams: testData.SYSTEM.slice(),
      selectedGroupId: null,
      jstreeInstance: null,
      nodesMap: {}
    };

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    var elements = {
      selectedGroupSelect: document.getElementById('selectedGroupSelect'),
      selectedInfo: document.getElementById('selected-info'),
      treeRoot: document.getElementById('tree-root'),
      messageContainer: document.getElementById('message-container'),
      groupsPreview: document.getElementById('groups-preview'),
      systemPreview: document.getElementById('system-preview'),
      logContainer: document.getElementById('log-container'),
      lastSave: document.getElementById('last-save'),
      statTotal: document.getElementById('stat-total'),
      statRoots: document.getElementById('stat-roots'),
      statDepth: document.getElementById('stat-depth')
    };

    // –õ–æ–≥–≥–µ—Ä
    function log(message) {
      var time = new Date().toLocaleTimeString();
      var logLine = '[' + time + '] ' + message;
      console.log(logLine);
      elements.logContainer.innerHTML += '<div>' + logLine + '</div>';
      elements.logContainer.scrollTop = elements.logContainer.scrollHeight;
    }

    // ========================================
    // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏–∏ (–∫–∞–∫ –≤ tree.js)
    // ========================================

    function escapeHtml(text) {
      if (!text) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function buildNodeText(group) {
      var name = escapeHtml(group.name || '');
      var code = escapeHtml(group.code || '');
      
      if (name && code) {
        return '<span class="node-name">' + name + '</span>' +
               '<span class="node-separator">‚Äî</span>' +
               '<span class="node-code">' + code + '</span>';
      }
      if (name) return '<span class="node-name">' + name + '</span>';
      if (code) return '<span class="node-code">' + code + '</span>';
      return '';
    }

    function createNodesMap(groups) {
      var map = {};
      groups.forEach(function(group) {
        map[group.id] = {
          id: group.id,
          text: buildNodeText(group),
          code: group.code || '',
          name: group.name || '',
          parentId: group.parent_id || 0,
          children: [],
          recordId: group.id
        };
      });
      return map;
    }

    function linkParentChild(map, groups) {
      groups.forEach(function(group) {
        var nodeId = group.id;
        var parentId = group.parent_id || 0;
        
        if (parentId !== 0 && map[parentId]) {
          map[nodeId].parentId = parentId;
          if (map[parentId].children.indexOf(nodeId) === -1) {
            map[parentId].children.push(nodeId);
          }
        }
      });
    }

    function findRootNodes(map) {
      var roots = [];
      Object.values(map).forEach(function(node) {
        if (!node.parentId || !map[node.parentId]) {
          roots.push(node);
        }
      });
      return roots;
    }

    function buildJsTreeNode(node, map) {
      var hasChildren = node.children && node.children.length > 0;
      
      var jsTreeNode = {
        id: String(node.id),
        text: node.text,
        state: { opened: true, selected: false },
        data: {
          devGroupId: node.id,
          code: node.code,
          name: node.name,
          recordId: node.recordId,
          children: node.children
        },
        li_attr: { 'data-group-id': node.id },
        a_attr: { 'href': '#', 'data-group-id': node.id }
      };
      
      if (hasChildren) {
        jsTreeNode.children = [];
        node.children.forEach(function(childId) {
          var childNode = map[childId];
          if (childNode) {
            jsTreeNode.children.push(buildJsTreeNode(childNode, map));
          }
        });
        jsTreeNode.icon = 'jstree-folder';
      } else {
        jsTreeNode.icon = 'jstree-file';
      }
      
      return jsTreeNode;
    }

    function convertToJsTreeData(groups) {
      if (!groups || groups.length === 0) return [];

      groups.sort(function(a, b) {
        return (a.manualSort || 0) - (b.manualSort || 0);
      });

      state.nodesMap = createNodesMap(groups);
      linkParentChild(state.nodesMap, groups);
      var rootNodes = findRootNodes(state.nodesMap);
      
      var jsTreeData = [];
      rootNodes.forEach(function(rootNode) {
        jsTreeData.push(buildJsTreeNode(rootNode, state.nodesMap));
      });
      
      return jsTreeData;
    }

    // ========================================
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
    // ========================================

    function renderTree() {
      var treeData = convertToJsTreeData(state.deviceGroups);

      if (!treeData || treeData.length === 0) {
        elements.treeRoot.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üå≥</div><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p></div>';
        return;
      }

      // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä–æ–µ –¥–µ—Ä–µ–≤–æ
      if (state.jstreeInstance) {
        $(elements.treeRoot).jstree('destroy');
      }

      // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –¥–µ—Ä–µ–≤–æ
      $(elements.treeRoot).jstree({
        core: {
          data: treeData,
          themes: { name: 'default', responsive: true, dots: false },
          animation: 150,
          check_callback: true
        },
        plugins: ['types', 'wholerow'],
        types: {
          'default': { icon: 'jstree-folder' },
          'file': { icon: 'jstree-file' }
        },
        wholerow: { stripes: false }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ - –í–ê–ñ–ù–û: —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π
      $(elements.treeRoot).on('select_node.jstree', function(event, data) {
        if (data.node) {
          var groupId = null;
          
          // –ü–æ–ª—É—á–∞–µ–º ID –∏–∑ data.devGroupId
          if (data.node.data && data.node.data.devGroupId !== undefined) {
            groupId = data.node.data.devGroupId;
          }
          // –ü–æ–ª—É—á–∞–µ–º –∏–∑ li_attr
          else if (data.node.li_attr && data.node.li_attr['data-group-id']) {
            groupId = parseInt(data.node.li_attr['data-group-id'], 10);
          }
          // –ü–æ–ª—É—á–∞–µ–º –∏–∑ id
          else if (data.node.id) {
            groupId = parseInt(data.node.id, 10);
          }
          
          log('–í—ã–±—Ä–∞–Ω —É–∑–µ–ª: ' + data.node.text + ' (ID: ' + groupId + ')');
          
          state.selectedGroupId = groupId;
          state.systemParams[0].value = String(groupId);
          
          updateSelectedInfo();
          updatePreview();
          updateLastSave();
        }
      });

      state.jstreeInstance = $(elements.treeRoot).jstree(true);

      // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —É–∑–µ–ª
      setTimeout(function() {
        if (state.selectedGroupId) {
          updateSelectedInfo();
          var node = state.jstreeInstance.get_node(String(state.selectedGroupId));
          if (node) {
            state.jstreeInstance.select_node(node);
            state.jstreeInstance.open_to(state.selectedGroupId);
          }
        }
      }, 100);

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      updateStats(treeData);
      log('–î–µ—Ä–µ–≤–æ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–æ: ' + state.deviceGroups.length + ' —É–∑–ª–æ–≤');
    }

    function updateSelectedInfo() {
      var group = state.deviceGroups.find(function(g) {
        return g.id === state.selectedGroupId;
      });

      if (group) {
        elements.selectedInfo.textContent = group.name + ' (' + group.code + ')';
        elements.selectedInfo.classList.add('has-value');
      } else {
        elements.selectedInfo.textContent = '–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞';
        elements.selectedInfo.classList.remove('has-value');
      }
    }

    function updateStats(treeData) {
      elements.statTotal.textContent = state.deviceGroups.length;
      elements.statRoots.textContent = state.deviceGroups.filter(function(g) {
        return !g.parent_id || g.parent_id === 0;
      }).length;

      function calcDepth(nodes, depth) {
        var max = depth;
        nodes.forEach(function(node) {
          if (node.children && node.children.length > 0) {
            var d = calcDepth(node.children, depth + 1);
            if (d > max) max = d;
          }
        });
        return max;
      }
      elements.statDepth.textContent = calcDepth(treeData, 1);
    }

    function updatePreview() {
      elements.groupsPreview.textContent = JSON.stringify(state.deviceGroups, null, 2);
      elements.systemPreview.textContent = JSON.stringify(state.systemParams, null, 2);
    }

    function updateLastSave() {
      var now = new Date();
      elements.lastSave.textContent = now.toLocaleTimeString();
    }

    // ========================================
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    // ========================================

    function updateSelectedGroup() {
      var value = elements.selectedGroupSelect.value;
      state.selectedGroupId = value ? parseInt(value, 10) : null;
      state.systemParams[0].value = value || '';
      
      if (state.jstreeInstance && state.selectedGroupId) {
        var node = state.jstreeInstance.get_node(String(state.selectedGroupId));
        if (node) {
          state.jstreeInstance.select_node(node);
          state.jstreeInstance.open_to(state.selectedGroupId);
          log('–í—ã–±—Ä–∞–Ω–∞ –≥—Ä—É–ø–ø–∞ –∏–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞: ' + node.text);
        } else {
          log('–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –¥–µ—Ä–µ–≤–µ: ' + state.selectedGroupId);
        }
      }
      
      updateSelectedInfo();
      updatePreview();
      updateLastSave();
    }

    function expandAll() {
      if (state.jstreeInstance) {
        state.jstreeInstance.open_all();
        log('–†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã –≤—Å–µ —É–∑–ª—ã');
      }
    }

    function collapseAll() {
      if (state.jstreeInstance) {
        state.jstreeInstance.close_all();
        log('–°–≤–µ—Ä–Ω—É—Ç—ã –≤—Å–µ —É–∑–ª—ã');
      }
    }

    // ========================================
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    // ========================================

    function init() {
      elements.selectedGroupSelect.value = state.selectedGroupId || '';
      updatePreview();
      renderTree();
      log('–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
    }

    init();
  </script>
</body>
</html>
