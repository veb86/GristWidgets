<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BDControl Widget - –¢–µ—Å—Ç</title>
  <link rel="stylesheet" href="widget/BDControl/css/style.css">
  <style>
    body {
      background: #f0f2f5;
      padding: 20px;
    }
    .test-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .test-controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .test-controls h2 {
      margin-bottom: 15px;
      font-size: 16px;
    }
    .control-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }
    .control-group label {
      font-weight: 500;
      min-width: 150px;
    }
    .control-group select,
    .control-group input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .control-group button {
      padding: 8px 16px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s;
    }
    .control-group button:hover {
      background: #2563eb;
    }
    .widget-wrapper {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .data-preview {
      margin-top: 20px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .data-preview h3 {
      margin-bottom: 10px;
      font-size: 14px;
      color: #666;
    }
    .data-preview pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow: auto;
      max-height: 300px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–º -->
    <div class="test-controls">
      <h2>üß™ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–º</h2>

      <div class="control-group">
        <label for="selectedGroupSelect">–í—ã–±—Ä–∞–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞ (SYSTEM.value):</label>
        <select id="selectedGroupSelect">
          <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>
          <option value="1">1 - lighting (–û—Å–≤–µ—â–µ–Ω–∏–µ)</option>
          <option value="2">2 - protection (–ó–∞—â–∏—Ç–∞)</option>
          <option value="3">3 - cables (–ö–∞–±–µ–ª–∏)</option>
          <option value="4">4 - luminaires (–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏)</option>
          <option value="5">5 - lamps (–õ–∞–º–ø—ã)</option>
          <option value="6">6 - breakers (–ê–≤—Ç–æ–º–∞—Ç—ã)</option>
          <option value="999">999 - –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –≥—Ä—É–ø–ø–∞</option>
        </select>
        <button onclick="updateSelectedGroup()">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>

      <div class="control-group">
        <label>–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥—Ä—É–ø–ø—ã:</label>
        <span id="groups-info" style="color: #666;"></span>
      </div>

      <div class="control-group">
        <label>–£—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤—Å–µ–≥–æ:</label>
        <span id="devices-info" style="color: #666;"></span>
      </div>
    </div>

    <!-- –í–∏–¥–∂–µ—Ç -->
    <div class="widget-wrapper">
      <div class="container">
        <header class="widget-header">
          <h1>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≥—Ä—É–ø–ø—ã: <span id="group-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span></h1>
          <span id="devices-count" class="devices-count"></span>
        </header>

        <div id="message-container"></div>

        <div class="table-container">
          <table id="devices-table" class="devices-table">
            <thead>
              <tr>
                <th data-sort="name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                <th data-sort="brand">–ú–æ–¥–µ–ª—å</th>
                <th data-sort="factoryname">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</th>
                <th data-sort="unit">–ï–¥. –∏–∑–º.</th>
                <th data-sort="count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                <th data-sort="note">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                <th data-sort="gristHelper_Display2">–ì—Ä—É–ø–ø–∞</th>
              </tr>
            </thead>
            <tbody id="devices-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö -->
    <div class="data-preview">
      <h3>üìä device_groups</h3>
      <pre id="groups-preview"></pre>
    </div>

    <div class="data-preview">
      <h3>üìä device</h3>
      <pre id="devices-preview"></pre>
    </div>

    <div class="data-preview">
      <h3>üìä SYSTEM</h3>
      <pre id="system-preview"></pre>
    </div>
  </div>

  <script>
    // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    var testData = {
      device_groups: [
        { id: 1, manualSort: 1, parent_id: 0, code: 'lighting', name: '–û—Å–≤–µ—â–µ–Ω–∏–µ' },
        { id: 2, manualSort: 2, parent_id: 0, code: 'protection', name: '–ó–∞—â–∏—Ç–∞' },
        { id: 3, manualSort: 3, parent_id: 0, code: 'cables', name: '–ö–∞–±–µ–ª–∏' },
        { id: 4, manualSort: 1, parent_id: 1, code: 'luminaires', name: '–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏' },
        { id: 5, manualSort: 2, parent_id: 1, code: 'lamps', name: '–õ–∞–º–ø—ã' },
        { id: 6, manualSort: 1, parent_id: 2, code: 'breakers', name: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–∏' }
      ],
      device: [
        { id: 1, name: '–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫ LED-001', brand: 'Philips', factoryname: 'Philips Lighting', devgroup_id: 4, unit: '—à—Ç', count: 10, note: '–î–ª—è –æ—Ñ–∏—Å–∞', gristHelper_Display2: '–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏' },
        { id: 2, name: '–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫ LED-002', brand: 'Osram', factoryname: 'Osram GmbH', devgroup_id: 4, unit: '—à—Ç', count: 5, note: '–î–ª—è —Å–∫–ª–∞–¥–∞', gristHelper_Display2: '–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏' },
        { id: 3, name: '–õ–∞–º–ø–∞ –Ω–∞–∫–∞–ª–∏–≤–∞–Ω–∏—è 60W', brand: 'General Electric', factoryname: 'GE Lighting', devgroup_id: 5, unit: '—à—Ç', count: 50, note: '', gristHelper_Display2: '–õ–∞–º–ø—ã' },
        { id: 4, name: '–õ–∞–º–ø–∞ —Å–≤–µ—Ç–æ–¥–∏–æ–¥–Ω–∞—è E27', brand: 'Gauss', factoryname: 'Gauss LLC', devgroup_id: 5, unit: '—à—Ç', count: 100, note: '–¢—ë–ø–ª—ã–π —Å–≤–µ—Ç', gristHelper_Display2: '–õ–∞–º–ø—ã' },
        { id: 5, name: '–ê–≤—Ç–æ–º–∞—Ç 1P C16', brand: 'ABB', factoryname: 'ABB Stotz-Kontakt', devgroup_id: 6, unit: '—à—Ç', count: 20, note: '', gristHelper_Display2: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–∏' },
        { id: 6, name: '–ê–≤—Ç–æ–º–∞—Ç 1P C10', brand: 'Schneider Electric', factoryname: 'Schneider Electric', devgroup_id: 6, unit: '—à—Ç', count: 15, note: '–î–ª—è —Ä–æ–∑–µ—Ç–æ–∫', gristHelper_Display2: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–∏' },
        { id: 7, name: '–ö–∞–±–µ–ª—å –í–í–ì–Ω–≥ 3x2.5', brand: '–ö–∞–º–∫–∞–±–µ–ª—å', factoryname: '–ö–∞–º—Å–∫–∏–π –∫–∞–±–µ–ª—å', devgroup_id: 3, unit: '–º', count: 500, note: '–ë—É—Ö—Ç–∞ 100–º', gristHelper_Display2: '–ö–∞–±–µ–ª–∏' },
        { id: 8, name: '–ö–∞–±–µ–ª—å –í–í–ì–Ω–≥ 3x1.5', brand: '–°–µ–≤–∫–∞–±–µ–ª—å', factoryname: '–°–µ–≤–∫–∞–±–µ–ª—å', devgroup_id: 3, unit: '–º', count: 300, note: '', gristHelper_Display2: '–ö–∞–±–µ–ª–∏' }
      ],
      SYSTEM: [
        { id: 1, param: 'selectedGroupID', value: '1' }
      ]
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ
    var state = {
      deviceGroups: testData.device_groups.slice(),
      devices: testData.device.slice(),
      systemParams: testData.SYSTEM.slice(),
      selectedGroupId: 1,
      sortField: 'manualSort',
      sortDirection: 'asc'
    };

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    var elements = {
      groupName: document.getElementById('group-name'),
      devicesCount: document.getElementById('devices-count'),
      tableBody: document.getElementById('devices-tbody'),
      messageContainer: document.getElementById('message-container'),
      tableHeader: document.querySelector('.devices-table thead'),
      selectedGroupSelect: document.getElementById('selectedGroupSelect'),
      groupsInfo: document.getElementById('groups-info'),
      devicesInfo: document.getElementById('devices-info'),
      groupsPreview: document.getElementById('groups-preview'),
      devicesPreview: document.getElementById('devices-preview'),
      systemPreview: document.getElementById('system-preview')
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
      if (elements.tableHeader) {
        elements.tableHeader.addEventListener('click', handleSort);
      }
      updateInfo();
      updatePreview();
      render();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    function updateInfo() {
      elements.groupsInfo.textContent = state.deviceGroups.length + ' –≥—Ä—É–ø–ø';
      elements.devicesInfo.textContent = state.devices.length + ' —É—Å—Ç—Ä–æ–π—Å—Ç–≤';
      elements.selectedGroupSelect.value = state.selectedGroupId || '';
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é
    function updatePreview() {
      elements.groupsPreview.textContent = JSON.stringify(state.deviceGroups, null, 2);
      elements.devicesPreview.textContent = JSON.stringify(state.devices, null, 2);
      elements.systemPreview.textContent = JSON.stringify(state.systemParams, null, 2);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã
    function updateSelectedGroup() {
      var value = elements.selectedGroupSelect.value;
      state.selectedGroupId = value ? parseInt(value, 10) : null;
      state.systemParams[0].value = value || '';
      render();
      updatePreview();
    }

    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –≥—Ä—É–ø–ø—ã
    function getAllChildGroups(groupId) {
      var result = [groupId];
      var children = state.deviceGroups.filter(function(g) {
        return g.parent_id === groupId;
      });
      children.forEach(function(child) {
        result = result.concat(getAllChildGroups(child.id));
      });
      return result;
    }

    // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
    function getGroupNameById(groupId) {
      var group = state.deviceGroups.find(function(g) {
        return g.id === groupId;
      });
      return group ? group.name : null;
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    function getFilteredDevices() {
      if (!state.selectedGroupId) return [];
      var groupIds = getAllChildGroups(state.selectedGroupId);
      return state.devices.filter(function(device) {
        return groupIds.indexOf(device.devgroup_id) !== -1;
      });
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    function handleSort(event) {
      var th = event.target.closest('th[data-sort]');
      if (!th) return;
      var field = th.dataset.sort;
      if (state.sortField === field) {
        state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        state.sortField = field;
        state.sortDirection = 'asc';
      }
      render();
    }

    function sortDevices(devicesArray) {
      var sortField = state.sortField;
      var sortDirection = state.sortDirection;

      if (sortField === 'manualSort') {
        return devicesArray.sort(function(a, b) {
          var groupA = state.deviceGroups.find(function(g) { return g.id === a.devgroup_id; });
          var groupB = state.deviceGroups.find(function(g) { return g.id === b.devgroup_id; });
          var sortA = groupA ? (groupA.manualSort || 0) : 0;
          var sortB = groupB ? (groupB.manualSort || 0) : 0;
          return sortDirection === 'asc' ? sortA - sortB : sortB - sortA;
        });
      }

      return devicesArray.sort(function(a, b) {
        var valA = a[sortField] || '';
        var valB = b[sortField] || '';
        var numA = parseFloat(valA);
        var numB = parseFloat(valB);
        if (!isNaN(numA) && !isNaN(numB)) {
          return sortDirection === 'asc' ? numA - numB : numB - numA;
        }
        valA = String(valA).toLowerCase();
        valB = String(valB).toLowerCase();
        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // –°–æ–æ–±—â–µ–Ω–∏—è
    function showMessage(message, type) {
      elements.messageContainer.innerHTML = '<div class="message message-' + type + '">' + escapeHtml(message) + '</div>';
      elements.messageContainer.style.display = 'block';
    }

    function hideMessage() {
      elements.messageContainer.style.display = 'none';
      elements.messageContainer.innerHTML = '';
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
    function render() {
      hideMessage();

      if (state.selectedGroupId === null || state.selectedGroupId === undefined) {
        elements.groupName.textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
        elements.devicesCount.textContent = '';
        elements.tableBody.innerHTML = '';
        showMessage('–ì—Ä—É–ø–ø–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞', 'warning');
        return;
      }

      var groupName = getGroupNameById(state.selectedGroupId);
      if (!groupName) {
        elements.groupName.textContent = '#' + state.selectedGroupId + ' (–Ω–µ –Ω–∞–π–¥–µ–Ω–∞)';
        elements.devicesCount.textContent = '';
        elements.tableBody.innerHTML = '';
        showMessage('–í—ã–±—Ä–∞–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
        return;
      }

      elements.groupName.textContent = groupName;
      var filteredDevices = getFilteredDevices();
      elements.devicesCount.textContent = '(' + filteredDevices.length + ' —à—Ç.)';

      if (filteredDevices.length === 0) {
        elements.tableBody.innerHTML = '';
        showMessage('–í –¥–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ –Ω–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤', 'info');
        return;
      }

      var sortedDevices = sortDevices(filteredDevices);
      renderTable(sortedDevices);
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
    function renderTable(devicesArray) {
      var rows = devicesArray.map(function(device) {
        var group = state.deviceGroups.find(function(g) { return g.id === device.devgroup_id; });
        var groupName = device.gristHelper_Display2 || (group ? group.name : '');
        return '<tr>' +
          '<td>' + escapeHtml(device.name) + '</td>' +
          '<td>' + escapeHtml(device.brand) + '</td>' +
          '<td>' + escapeHtml(device.factoryname) + '</td>' +
          '<td>' + escapeHtml(device.unit || '') + '</td>' +
          '<td>' + escapeHtml(device.count || '') + '</td>' +
          '<td>' + escapeHtml(device.note || '') + '</td>' +
          '<td>' + escapeHtml(groupName) + '</td>' +
        '</tr>';
      }).join('');
      elements.tableBody.innerHTML = rows;
    }

    // –ó–∞–ø—É—Å–∫
    init();
  </script>
</body>
</html>
