<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BDControl Widget - –¢–µ—Å—Ç</title>
  <link rel="stylesheet" href="widget/BDControl/css/style.css">
  <style>
    body {
      background: #f0f2f5;
      padding: 20px;
    }
    .test-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .test-controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .test-controls h2 {
      margin-bottom: 15px;
      font-size: 16px;
    }
    .control-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }
    .control-group label {
      font-weight: 500;
      min-width: 150px;
    }
    .control-group select,
    .control-group input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .control-group button {
      padding: 8px 16px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s;
    }
    .control-group button:hover {
      background: #2563eb;
    }
    .widget-wrapper {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .data-preview {
      margin-top: 20px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .data-preview h3 {
      margin-bottom: 10px;
      font-size: 14px;
      color: #666;
    }
    .data-preview pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow: auto;
      max-height: 300px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–º -->
    <div class="test-controls">
      <h2>üß™ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–º</h2>

      <div class="control-group">
        <label for="selectedGroupSelect">–í—ã–±—Ä–∞–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞ (SYSTEM.value):</label>
        <select id="selectedGroupSelect">
          <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>
          <option value="1">1 - lighting (–û—Å–≤–µ—â–µ–Ω–∏–µ)</option>
          <option value="2">2 - protection (–ó–∞—â–∏—Ç–∞)</option>
          <option value="3">3 - cables (–ö–∞–±–µ–ª–∏)</option>
          <option value="4">4 - luminaires (–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏)</option>
          <option value="5">5 - lamps (–õ–∞–º–ø—ã)</option>
          <option value="6">6 - breakers (–ê–≤—Ç–æ–º–∞—Ç—ã)</option>
          <option value="999">999 - –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –≥—Ä—É–ø–ø–∞</option>
        </select>
        <button onclick="updateSelectedGroup()">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>

      <div class="control-group">
        <label>–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥—Ä—É–ø–ø—ã:</label>
        <span id="groups-info" style="color: #666;"></span>
      </div>

      <div class="control-group">
        <label>–£—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤—Å–µ–≥–æ:</label>
        <span id="devices-info" style="color: #666;"></span>
      </div>
    </div>

    <!-- –í–∏–¥–∂–µ—Ç -->
    <div class="widget-wrapper">
      <div class="container">
        <header class="widget-header">
          <h1>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≥—Ä—É–ø–ø—ã: <span id="group-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span></h1>
          <span id="devices-count" class="devices-count"></span>
        </header>

        <div id="message-container"></div>

        <div class="table-container">
          <table id="devices-table" class="devices-table">
            <thead>
              <tr id="devices-thead-tr">
                <!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
              </tr>
            </thead>
            <tbody id="devices-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö -->
    <div class="data-preview">
      <h3>üìä device_groups</h3>
      <pre id="groups-preview"></pre>
    </div>

    <div class="data-preview">
      <h3>üìä device</h3>
      <pre id="devices-preview"></pre>
    </div>

    <div class="data-preview">
      <h3>üìä SYSTEM</h3>
      <pre id="system-preview"></pre>
    </div>

    <div class="data-preview">
      <h3>üìä Characteristics</h3>
      <pre id="characteristics-preview"></pre>
    </div>

    <div class="data-preview">
      <h3>üìä Group_Characteristics</h3>
      <pre id="groupCharacteristics-preview"></pre>
    </div>

    <div class="data-preview">
      <h3>üìä Device_characteristics</h3>
      <pre id="deviceCharacteristics-preview"></pre>
    </div>
  </div>

  <script>
    // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    var testData = {
      device_groups: [
        { id: 1, manualSort: 1, parent_id: 0, code: 'lighting', name: '–û—Å–≤–µ—â–µ–Ω–∏–µ' },
        { id: 2, manualSort: 2, parent_id: 0, code: 'protection', name: '–ó–∞—â–∏—Ç–∞' },
        { id: 3, manualSort: 3, parent_id: 0, code: 'cables', name: '–ö–∞–±–µ–ª–∏' },
        { id: 4, manualSort: 1, parent_id: 1, code: 'luminaires', name: '–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏' },
        { id: 5, manualSort: 2, parent_id: 1, code: 'lamps', name: '–õ–∞–º–ø—ã' },
        { id: 6, manualSort: 1, parent_id: 2, code: 'breakers', name: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–∏' }
      ],
      device: [
        { id: 1, name: '–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫ LED-001', brand: 'Philips', factoryname: 'Philips Lighting', devgroup_id: 4, unit: '—à—Ç', count: 10, note: '–î–ª—è –æ—Ñ–∏—Å–∞', gristHelper_Display2: '–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏' },
        { id: 2, name: '–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫ LED-002', brand: 'Osram', factoryname: 'Osram GmbH', devgroup_id: 4, unit: '—à—Ç', count: 5, note: '–î–ª—è —Å–∫–ª–∞–¥–∞', gristHelper_Display2: '–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏' },
        { id: 3, name: '–õ–∞–º–ø–∞ –Ω–∞–∫–∞–ª–∏–≤–∞–Ω–∏—è 60W', brand: 'General Electric', factoryname: 'GE Lighting', devgroup_id: 5, unit: '—à—Ç', count: 50, note: '', gristHelper_Display2: '–õ–∞–º–ø—ã' },
        { id: 4, name: '–õ–∞–º–ø–∞ —Å–≤–µ—Ç–æ–¥–∏–æ–¥–Ω–∞—è E27', brand: 'Gauss', factoryname: 'Gauss LLC', devgroup_id: 5, unit: '—à—Ç', count: 100, note: '–¢—ë–ø–ª—ã–π —Å–≤–µ—Ç', gristHelper_Display2: '–õ–∞–º–ø—ã' },
        { id: 5, name: '–ê–≤—Ç–æ–º–∞—Ç 1P C16', brand: 'ABB', factoryname: 'ABB Stotz-Kontakt', devgroup_id: 6, unit: '—à—Ç', count: 20, note: '', gristHelper_Display2: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–∏' },
        { id: 6, name: '–ê–≤—Ç–æ–º–∞—Ç 1P C10', brand: 'Schneider Electric', factoryname: 'Schneider Electric', devgroup_id: 6, unit: '—à—Ç', count: 15, note: '–î–ª—è —Ä–æ–∑–µ—Ç–æ–∫', gristHelper_Display2: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–∏' },
        { id: 7, name: '–ö–∞–±–µ–ª—å –í–í–ì–Ω–≥ 3x2.5', brand: '–ö–∞–º–∫–∞–±–µ–ª—å', factoryname: '–ö–∞–º—Å–∫–∏–π –∫–∞–±–µ–ª—å', devgroup_id: 3, unit: '–º', count: 500, note: '–ë—É—Ö—Ç–∞ 100–º', gristHelper_Display2: '–ö–∞–±–µ–ª–∏' },
        { id: 8, name: '–ö–∞–±–µ–ª—å –í–í–ì–Ω–≥ 3x1.5', brand: '–°–µ–≤–∫–∞–±–µ–ª—å', factoryname: '–°–µ–≤–∫–∞–±–µ–ª—å', devgroup_id: 3, unit: '–º', count: 300, note: '', gristHelper_Display2: '–ö–∞–±–µ–ª–∏' }
      ],
      SYSTEM: [
        { id: 1, param: 'selectedGroupID', value: '1' }
      ],
      Characteristics: [
        { id: 1, manualSort: 1, group_id: 1, code: 'power', name: '–ú–æ—â–Ω–æ—Å—Ç—å', data_type: 'float', unit: '–í—Ç' },
        { id: 2, manualSort: 2, group_id: 1, code: 'voltage', name: '–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è', data_type: 'string', unit: '–í' },
        { id: 3, manualSort: 3, group_id: 2, code: 'luminous_flux', name: '–°–≤–µ—Ç–æ–≤–æ–π –ø–æ—Ç–æ–∫', data_type: 'integer', unit: '–ª–º' },
        { id: 4, manualSort: 4, group_id: 2, code: 'color_temperature', name: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞', data_type: 'integer', unit: '–ö' }
      ],
      Group_Characteristics: [
        { id: 1, manualSort: 1, group_id: 4, characteristic_id: 1, is_visible: true, sort_order: 1 },
        { id: 2, manualSort: 2, group_id: 4, characteristic_id: 2, is_visible: true, sort_order: 2 },
        { id: 3, manualSort: 3, group_id: 4, characteristic_id: 3, is_visible: true, sort_order: 3 },
        { id: 4, manualSort: 4, group_id: 4, characteristic_id: 4, is_visible: true, sort_order: 4 },
        { id: 5, manualSort: 5, group_id: 5, characteristic_id: 1, is_visible: true, sort_order: 1 },
        { id: 6, manualSort: 6, group_id: 5, characteristic_id: 3, is_visible: true, sort_order: 2 },
        { id: 7, manualSort: 7, group_id: 5, characteristic_id: 4, is_visible: true, sort_order: 3 }
      ],
      Device_characteristics: [
        { id: 1, manualSort: 1, device_id: 1, characteristic_id: 1, value_float: 40, value_int: 0, value_string: '', value_bool: 0 },
        { id: 2, manualSort: 2, device_id: 1, characteristic_id: 2, value_float: 0, value_int: 0, value_string: '220', value_bool: 0 },
        { id: 3, manualSort: 3, device_id: 1, characteristic_id: 3, value_float: 0, value_int: 4200, value_string: '', value_bool: 0 },
        { id: 4, manualSort: 4, device_id: 1, characteristic_id: 4, value_float: 0, value_int: 4000, value_string: '', value_bool: 0 },
        { id: 5, manualSort: 5, device_id: 2, characteristic_id: 1, value_float: 36, value_int: 0, value_string: '', value_bool: 0 },
        { id: 6, manualSort: 6, device_id: 2, characteristic_id: 2, value_float: 0, value_int: 0, value_string: '220', value_bool: 0 },
        { id: 7, manualSort: 7, device_id: 2, characteristic_id: 3, value_float: 0, value_int: 3800, value_string: '', value_bool: 0 },
        { id: 8, manualSort: 8, device_id: 2, characteristic_id: 4, value_float: 0, value_int: 4000, value_string: '', value_bool: 0 },
        { id: 9, manualSort: 9, device_id: 3, characteristic_id: 1, value_float: 60, value_int: 0, value_string: '', value_bool: 0 },
        { id: 10, manualSort: 10, device_id: 3, characteristic_id: 3, value_float: 0, value_int: 800, value_string: '', value_bool: 0 },
        { id: 11, manualSort: 11, device_id: 4, characteristic_id: 1, value_float: 10, value_int: 0, value_string: '', value_bool: 0 },
        { id: 12, manualSort: 12, device_id: 4, characteristic_id: 3, value_float: 0, value_int: 900, value_string: '', value_bool: 0 },
        { id: 13, manualSort: 13, device_id: 4, characteristic_id: 4, value_float: 0, value_int: 2700, value_string: '', value_bool: 0 }
      ]
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ
    var state = {
      deviceGroups: testData.device_groups.slice(),
      devices: testData.device.slice(),
      systemParams: testData.SYSTEM.slice(),
      characteristics: testData.Characteristics.slice(),
      groupCharacteristics: testData.Group_Characteristics.slice(),
      deviceCharacteristics: testData.Device_characteristics.slice(),
      selectedGroupId: 1,
      sortField: 'manualSort',
      sortDirection: 'asc'
    };

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    var elements = {
      groupName: document.getElementById('group-name'),
      devicesCount: document.getElementById('devices-count'),
      tableBody: document.getElementById('devices-tbody'),
      messageContainer: document.getElementById('message-container'),
      tableHeader: document.querySelector('.devices-table thead'),
      selectedGroupSelect: document.getElementById('selectedGroupSelect'),
      groupsInfo: document.getElementById('groups-info'),
      devicesInfo: document.getElementById('devices-info'),
      groupsPreview: document.getElementById('groups-preview'),
      devicesPreview: document.getElementById('devices-preview'),
      systemPreview: document.getElementById('system-preview'),
      characteristicsPreview: document.getElementById('characteristics-preview'),
      groupCharacteristicsPreview: document.getElementById('groupCharacteristics-preview'),
      deviceCharacteristicsPreview: document.getElementById('deviceCharacteristics-preview')
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
      if (elements.tableHeader) {
        elements.tableHeader.addEventListener('click', handleSort);
      }
      updateInfo();
      updatePreview();
      render();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    function updateInfo() {
      elements.groupsInfo.textContent = state.deviceGroups.length + ' –≥—Ä—É–ø–ø';
      elements.devicesInfo.textContent = state.devices.length + ' —É—Å—Ç—Ä–æ–π—Å—Ç–≤';
      elements.selectedGroupSelect.value = state.selectedGroupId || '';
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é
    function updatePreview() {
      elements.groupsPreview.textContent = JSON.stringify(state.deviceGroups, null, 2);
      elements.devicesPreview.textContent = JSON.stringify(state.devices, null, 2);
      elements.systemPreview.textContent = JSON.stringify(state.systemParams, null, 2);
      elements.characteristicsPreview.textContent = JSON.stringify(state.characteristics, null, 2);
      elements.groupCharacteristicsPreview.textContent = JSON.stringify(state.groupCharacteristics, null, 2);
      elements.deviceCharacteristicsPreview.textContent = JSON.stringify(state.deviceCharacteristics, null, 2);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã
    function updateSelectedGroup() {
      var value = elements.selectedGroupSelect.value;
      state.selectedGroupId = value ? parseInt(value, 10) : null;
      state.systemParams[0].value = value || '';
      render();
      updatePreview();
    }

    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –≥—Ä—É–ø–ø—ã
    function getAllChildGroups(groupId) {
      var result = [groupId];
      var children = state.deviceGroups.filter(function(g) {
        return g.parent_id === groupId;
      });
      children.forEach(function(child) {
        result = result.concat(getAllChildGroups(child.id));
      });
      return result;
    }

    // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
    function getGroupNameById(groupId) {
      var group = state.deviceGroups.find(function(g) {
        return g.id === groupId;
      });
      return group ? group.name : null;
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    function getFilteredDevices() {
      if (!state.selectedGroupId) return [];
      var groupIds = getAllChildGroups(state.selectedGroupId);
      return state.devices.filter(function(device) {
        return groupIds.indexOf(device.devgroup_id) !== -1;
      });
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã
    function getCharacteristicsForGroup(groupId) {
      if (groupId === null || groupId === undefined) return [];
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫ —á–∏—Å–ª—É –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
      var groupIdNum = parseInt(groupId, 10);
      
      // –§–∏–ª—å—Ç—Ä—É–µ–º Group_Characteristics –ø–æ group_id
      var groupChars = state.groupCharacteristics.filter(function(gc) {
        var gcGroupId = parseInt(gc.group_id, 10);
        return gcGroupId === groupIdNum;
      });

      // –î–ª—è –∫–∞–∂–¥–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
      return groupChars.map(function(gc) {
        var characteristic = state.characteristics.find(function(c) {
          var cId = parseInt(c.id, 10);
          var gcCharId = parseInt(gc.characteristic_id, 10);
          return cId === gcCharId;
        });

        return {
          id: gc.id,
          characteristic_id: gc.characteristic_id,
          group_id: gc.group_id,
          code: characteristic ? characteristic.code : null,
          name: characteristic ? characteristic.name : null,
          data_type: characteristic ? characteristic.data_type : 'string',
          unit: characteristic ? characteristic.unit : '',
          is_visible: gc.is_visible !== false,
          sort_order: gc.sort_order || 0
        };
      }).sort(function(a, b) {
        return (a.sort_order || 0) - (b.sort_order || 0);
      });
    }

    // –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    function getCharacteristicValue(deviceId, characteristicId) {
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫ —á–∏—Å–ª–∞–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
      var deviceIdNum = parseInt(deviceId, 10);
      var characteristicIdNum = parseInt(characteristicId, 10);
      
      var deviceChar = state.deviceCharacteristics.find(function(dc) {
        var dcDeviceId = parseInt(dc.device_id, 10);
        var dcCharId = parseInt(dc.characteristic_id, 10);
        return dcDeviceId === deviceIdNum && dcCharId === characteristicIdNum;
      });

      if (!deviceChar) return null;

      // –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ Characteristics
      var characteristic = state.characteristics.find(function(c) {
        return parseInt(c.id, 10) === characteristicIdNum;
      });
      
      var dataType = characteristic ? characteristic.data_type : null;

      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç data_type
      if (dataType === 'float') {
        return deviceChar.value_float !== undefined && deviceChar.value_float !== null 
          ? deviceChar.value_float 
          : null;
      }
      
      if (dataType === 'integer') {
        return deviceChar.value_int !== undefined && deviceChar.value_int !== null 
          ? deviceChar.value_int 
          : null;
      }
      
      if (dataType === 'string') {
        return deviceChar.value_string !== undefined && deviceChar.value_string !== null && deviceChar.value_string !== ''
          ? deviceChar.value_string 
          : null;
      }
      
      if (dataType === 'bool' || dataType === 'boolean') {
        return deviceChar.value_bool !== undefined && deviceChar.value_bool !== null 
          ? deviceChar.value_bool 
          : null;
      }

      // –ï—Å–ª–∏ data_type –Ω–µ —É–∫–∞–∑–∞–Ω, –ø—Ä–æ–±—É–µ–º —É–≥–∞–¥–∞—Ç—å –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
      if (deviceChar.value_string !== undefined && deviceChar.value_string !== null && deviceChar.value_string !== '') {
        return deviceChar.value_string;
      }
      if (deviceChar.value_float !== undefined && deviceChar.value_float !== null) {
        return deviceChar.value_float;
      }
      if (deviceChar.value_int !== undefined && deviceChar.value_int !== null) {
        return deviceChar.value_int;
      }
      if (deviceChar.value_bool !== undefined && deviceChar.value_bool !== null) {
        return deviceChar.value_bool;
      }

      return null;
    }

    // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π –≥—Ä—É–ø–ø—ã
    function getColumnsForGroup(groupId) {
      // –ë–∞–∑–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏
      var columns = [
        { key: 'name', title: '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ' },
        { key: 'brand', title: '–ú–æ–¥–µ–ª—å' },
        { key: 'factoryname', title: '–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å' },
        { key: 'unit', title: '–ï–¥. –∏–∑–º.' },
        { key: 'count', title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ' },
        { key: 'note', title: '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ' },
        { key: 'gristHelper_Display2', title: '–ì—Ä—É–ø–ø–∞' }
      ];

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
      var characteristics = getCharacteristicsForGroup(groupId);
      characteristics.forEach(function(char) {
        if (char.is_visible) {
          columns.push({
            key: 'char_' + char.code,
            title: char.name + (char.unit ? ' (' + char.unit + ')' : ''),
            characteristic_id: char.characteristic_id,
            code: char.code
          });
        }
      });

      return columns;
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    function handleSort(event) {
      var th = event.target.closest('th[data-sort]');
      if (!th) return;
      var field = th.dataset.sort;
      if (state.sortField === field) {
        state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        state.sortField = field;
        state.sortDirection = 'asc';
      }
      render();
    }

    function sortDevices(devicesArray) {
      var sortField = state.sortField;
      var sortDirection = state.sortDirection;

      if (sortField === 'manualSort') {
        return devicesArray.sort(function(a, b) {
          var groupA = state.deviceGroups.find(function(g) { return g.id === a.devgroup_id; });
          var groupB = state.deviceGroups.find(function(g) { return g.id === b.devgroup_id; });
          var sortA = groupA ? (groupA.manualSort || 0) : 0;
          var sortB = groupB ? (groupB.manualSort || 0) : 0;
          return sortDirection === 'asc' ? sortA - sortB : sortB - sortA;
        });
      }

      return devicesArray.sort(function(a, b) {
        var valA = a[sortField] || '';
        var valB = b[sortField] || '';
        var numA = parseFloat(valA);
        var numB = parseFloat(valB);
        if (!isNaN(numA) && !isNaN(numB)) {
          return sortDirection === 'asc' ? numA - numB : numB - numA;
        }
        valA = String(valA).toLowerCase();
        valB = String(valB).toLowerCase();
        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // –°–æ–æ–±—â–µ–Ω–∏—è
    function showMessage(message, type) {
      elements.messageContainer.innerHTML = '<div class="message message-' + type + '">' + escapeHtml(message) + '</div>';
      elements.messageContainer.style.display = 'block';
    }

    function hideMessage() {
      elements.messageContainer.style.display = 'none';
      elements.messageContainer.innerHTML = '';
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
    function render() {
      hideMessage();

      if (state.selectedGroupId === null || state.selectedGroupId === undefined) {
        elements.groupName.textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
        elements.devicesCount.textContent = '';
        elements.tableBody.innerHTML = '';
        renderTableHeader(); // –û—á–∏—â–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
        showMessage('–ì—Ä—É–ø–ø–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞', 'warning');
        return;
      }

      var groupName = getGroupNameById(state.selectedGroupId);
      if (!groupName) {
        elements.groupName.textContent = '#' + state.selectedGroupId + ' (–Ω–µ –Ω–∞–π–¥–µ–Ω–∞)';
        elements.devicesCount.textContent = '';
        elements.tableBody.innerHTML = '';
        renderTableHeader(); // –û—á–∏—â–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
        showMessage('–í—ã–±—Ä–∞–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
        return;
      }

      elements.groupName.textContent = groupName;
      
      // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π –≥—Ä—É–ø–ø—ã
      renderTableHeader();
      
      var filteredDevices = getFilteredDevices();
      elements.devicesCount.textContent = '(' + filteredDevices.length + ' —à—Ç.)';

      if (filteredDevices.length === 0) {
        elements.tableBody.innerHTML = '';
        showMessage('–í –¥–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ –Ω–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤', 'info');
        return;
      }

      var sortedDevices = sortDevices(filteredDevices);
      renderTable(sortedDevices);
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ç–∞–±–ª–∏—Ü—ã
    function renderTableHeader() {
      var theadTr = document.getElementById('devices-thead-tr');
      if (!theadTr) return;

      var columns = getColumnsForGroup(state.selectedGroupId);
      var headers = columns.map(function(col) {
        return '<th data-sort="' + col.key + '">' + escapeHtml(col.title) + '</th>';
      }).join('');

      theadTr.innerHTML = headers;
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
    function renderTable(devicesArray) {
      var columns = getColumnsForGroup(state.selectedGroupId);

      var rows = devicesArray.map(function(device) {
        var group = state.deviceGroups.find(function(g) { return g.id === device.devgroup_id; });
        var groupName = device.gristHelper_Display2 || (group ? group.name : '');

        // –§–æ—Ä–º–∏—Ä—É–µ–º —è—á–µ–π–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏
        var cells = columns.map(function(col) {
          var value;

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–ª–æ–Ω–∫–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–æ–π
          if (col.code) {
            // –≠—Ç–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ - –ø–æ–ª—É—á–∞–µ–º –µ—ë –∑–Ω–∞—á–µ–Ω–∏–µ
            value = getCharacteristicValue(device.id, col.characteristic_id);
            value = value !== null ? value : '';
          } else {
            // –≠—Ç–æ –±–∞–∑–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞
            value = device[col.key] || '';
          }

          return '<td>' + escapeHtml(value) + '</td>';
        }).join('');

        return '<tr>' + cells + '</tr>';
      }).join('');

      elements.tableBody.innerHTML = rows;
    }

    // –ó–∞–ø—É—Å–∫
    init();
  </script>
</body>
</html>
