<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Тест логики managerCalc</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f0f0f0;
    }

    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h2 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }

    .test-case {
      margin: 10px 0;
      padding: 10px;
      background-color: #f9f9f9;
      border-left: 4px solid #2196F3;
    }

    .success {
      color: #4CAF50;
      font-weight: bold;
    }

    .error {
      color: #f44336;
      font-weight: bold;
    }

    pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #4CAF50;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Тестирование логики расчёта путей managerCalc</h1>

  <div class="test-section">
    <h2>Тестовые данные</h2>
    <table id="test-data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Устройство</th>
          <th>Родитель ID</th>
          <th>Может быть головным</th>
        </tr>
      </thead>
      <tbody id="test-data-body"></tbody>
    </table>
  </div>

  <div class="test-section">
    <h2>Результаты расчёта путей</h2>
    <table id="results-table">
      <thead>
        <tr>
          <th>Устройство</th>
          <th>fullpath</th>
          <th>onlyGUpath</th>
          <th>Статус</th>
        </tr>
      </thead>
      <tbody id="results-body"></tbody>
    </table>
  </div>

  <div class="test-section">
    <h2>Лог тестирования</h2>
    <pre id="test-log"></pre>
  </div>

  <!-- Подключаем модули виджета -->
  <script src="../widget/managerCalc/js/config.js"></script>
  <script>
    // Создаём упрощённую версию DataModule для тестов
    const DataModule = {
      createDeviceMap(devices) {
        const deviceMap = new Map();
        devices.forEach(device => {
          deviceMap.set(device.rowId, device);
        });
        return deviceMap;
      }
    };
  </script>
  <script src="../widget/managerCalc/js/pathCalculator.js"></script>

  <script>
    // Тестовые данные согласно примеру из задания
    const testDevices = [
      {
        rowId: 1,
        deviceName: 'ВРУ',
        parentId: null,
        canBeHead: true,
        onlyGUpath: '',
        fullpath: ''
      },
      {
        rowId: 2,
        deviceName: 'ГРЩ',
        parentId: 1,
        canBeHead: true,
        onlyGUpath: '',
        fullpath: ''
      },
      {
        rowId: 3,
        deviceName: 'ЩР',
        parentId: 2,
        canBeHead: false,
        onlyGUpath: '',
        fullpath: ''
      },
      {
        rowId: 4,
        deviceName: 'МФУ',
        parentId: 3,
        canBeHead: false,
        onlyGUpath: '',
        fullpath: ''
      }
    ];

    // Ожидаемые результаты
    const expectedResults = {
      1: { fullpath: 'ВРУ', onlyGUpath: 'ВРУ' },
      2: { fullpath: 'ВРУ\\ГРЩ', onlyGUpath: 'ВРУ\\ГРЩ' },
      3: { fullpath: 'ВРУ\\ГРЩ\\ЩР', onlyGUpath: 'ВРУ\\ГРЩ' },
      4: { fullpath: 'ВРУ\\ГРЩ\\ЩР\\МФУ', onlyGUpath: 'ВРУ\\ГРЩ' }
    };

    let log = '';

    function addLog(message) {
      log += message + '\n';
      document.getElementById('test-log').textContent = log;
    }

    function displayTestData() {
      const tbody = document.getElementById('test-data-body');
      testDevices.forEach(device => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = device.rowId;
        row.insertCell(1).textContent = device.deviceName;
        row.insertCell(2).textContent = device.parentId || '-';
        row.insertCell(3).textContent = device.canBeHead ? '✅' : '❌';
      });
    }

    function runTests() {
      addLog('=== Начало тестирования ===\n');

      // Создаём словарь устройств
      const deviceMap = DataModule.createDeviceMap(testDevices);
      addLog(`Создан словарь устройств: ${deviceMap.size} записей`);

      // Тестируем расчёт путей для каждого устройства
      const resultsBody = document.getElementById('results-body');
      let allTestsPassed = true;

      testDevices.forEach(device => {
        addLog(`\nТестирование устройства: ${device.deviceName} (ID: ${device.rowId})`);

        // Рассчитываем пути
        const fullpath = PathCalculator.buildFullPath(device.rowId, deviceMap);
        const onlyGUpath = PathCalculator.buildOnlyGUPath(device.rowId, deviceMap);

        addLog(`  fullpath: "${fullpath}"`);
        addLog(`  onlyGUpath: "${onlyGUpath}"`);

        // Проверяем результаты
        const expected = expectedResults[device.rowId];
        const fullpathMatch = fullpath === expected.fullpath;
        const onlyGUpathMatch = onlyGUpath === expected.onlyGUpath;
        const testPassed = fullpathMatch && onlyGUpathMatch;

        if (!testPassed) {
          allTestsPassed = false;
          addLog(`  ❌ ОШИБКА:`);
          if (!fullpathMatch) {
            addLog(`     fullpath: ожидалось "${expected.fullpath}", получено "${fullpath}"`);
          }
          if (!onlyGUpathMatch) {
            addLog(`     onlyGUpath: ожидалось "${expected.onlyGUpath}", получено "${onlyGUpath}"`);
          }
        } else {
          addLog(`  ✅ Тест пройден`);
        }

        // Добавляем результат в таблицу
        const row = resultsBody.insertRow();
        row.insertCell(0).textContent = device.deviceName;
        row.insertCell(1).textContent = fullpath;
        row.insertCell(2).textContent = onlyGUpath;

        const statusCell = row.insertCell(3);
        statusCell.textContent = testPassed ? '✅ OK' : '❌ FAIL';
        statusCell.className = testPassed ? 'success' : 'error';
      });

      // Итоговый результат
      addLog('\n=== Результаты тестирования ===');
      if (allTestsPassed) {
        addLog('✅ ВСЕ ТЕСТЫ ПРОЙДЕНЫ УСПЕШНО!');
      } else {
        addLog('❌ НЕКОТОРЫЕ ТЕСТЫ НЕ ПРОШЛИ!');
      }

      // Тестируем кэширование
      addLog('\n=== Проверка кэширования ===');
      addLog(`Размер кэша fullpath: ${PathCalculator.cache.fullpath.size}`);
      addLog(`Размер кэша onlyGUpath: ${PathCalculator.cache.onlyGUpath.size}`);

      // Тестируем валидацию
      addLog('\n=== Проверка валидации ===');
      const validation = PathCalculator.validateData(testDevices);
      addLog(`Валидация пройдена: ${validation.isValid ? '✅' : '❌'}`);
      if (!validation.isValid) {
        validation.errors.forEach(error => addLog(`  - ${error}`));
      }
    }

    // Запускаем тесты при загрузке страницы
    window.addEventListener('load', () => {
      displayTestData();
      runTests();
    });
  </script>
</body>
</html>
