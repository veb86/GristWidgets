<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Final Test - Real Issue Data</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; }
    .success { color: #28a745; font-weight: bold; }
    .error { color: #dc3545; font-weight: bold; }
    .warning { color: #856404; font-weight: bold; }
    pre { background: #f8f9fa; padding: 10px; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    th { background-color: #f2f2f2; }
    .highlight { background-color: #fff3cd; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Final Test with Real Issue Data</h1>
    <button onclick="runFinalTest()">Run Final Test</button>
    <div id="results"></div>
  </div>

  <script src="../widget/managerCalc/js/powerCalculator.js"></script>

  <script>
    // Exact data from the issue comment
    const issueData = [
      { rowId: 1, nmoBaseName: 'ЩР', headDeviceName: 'ВРУ1', power: 0.12 },
      { rowId: 2, nmoBaseName: 'EL5', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 3, nmoBaseName: 'EL7', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 4, nmoBaseName: 'EL5', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 5, nmoBaseName: 'EL6', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 6, nmoBaseName: 'Вкл', headDeviceName: 'ЩР', power: 0 },
      { rowId: 7, nmoBaseName: 'ЩР1', headDeviceName: 'ВРУ1', power: 14.48 },
      { rowId: 8, nmoBaseName: 'ЩР1', headDeviceName: 'ВРУ2', power: 14.48 },
      { rowId: 9, nmoBaseName: 'EL1', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 10, nmoBaseName: 'EL3', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 11, nmoBaseName: 'EL1', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 12, nmoBaseName: 'EL2', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 13, nmoBaseName: 'Вкл', headDeviceName: 'ЩР1', power: 0 },
      { rowId: 14, nmoBaseName: 'ВРУ1', headDeviceName: '???', power: 14.48 },
      { rowId: 15, nmoBaseName: 'ВРУ2', headDeviceName: '???', power: 14.48 },
      { rowId: 16, nmoBaseName: 'EL1', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 17, nmoBaseName: 'EL1', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 18, nmoBaseName: 'ШУ1', headDeviceName: 'ЩР1', power: 6.240000000000002 },
      { rowId: 19, nmoBaseName: 'ЯУ1', headDeviceName: 'ШУ1', power: 2 },
      { rowId: 20, nmoBaseName: 'Дв1', headDeviceName: 'ЯУ1', power: 1 },
      { rowId: 21, nmoBaseName: 'Дв2', headDeviceName: 'ЯУ1', power: 1 },
      { rowId: 22, nmoBaseName: 'ШУ2', headDeviceName: 'ЩР1', power: 2 },
      { rowId: 23, nmoBaseName: 'ЯУ2', headDeviceName: 'ШУ2', power: 2 },
      { rowId: 24, nmoBaseName: 'Дв3', headDeviceName: 'ЯУ2', power: 1 },
      { rowId: 25, nmoBaseName: 'Дв4', headDeviceName: 'ЯУ2', power: 1 },
      { rowId: 26, nmoBaseName: 'ЯУ3', headDeviceName: 'ШУ1', power: 2 },
      { rowId: 27, nmoBaseName: 'Дв5', headDeviceName: 'ЯУ3', power: 1 },
      { rowId: 28, nmoBaseName: 'Дв6', headDeviceName: 'ЯУ3', power: 1 },
      { rowId: 29, nmoBaseName: 'EL8', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 30, nmoBaseName: 'EL9', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 31, nmoBaseName: 'EL9', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 32, nmoBaseName: 'EL8', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 33, nmoBaseName: 'EL8', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 34, nmoBaseName: 'EL9', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 35, nmoBaseName: 'ЯУ77', headDeviceName: 'ШУ1', power: 2 },
      { rowId: 36, nmoBaseName: 'Дв771', headDeviceName: 'ЯУ77', power: 1 },
      { rowId: 37, nmoBaseName: 'Дв772', headDeviceName: 'ЯУ77', power: 1 },
      { rowId: 38, nmoBaseName: 'EL9', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 39, nmoBaseName: 'EL77', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 40, nmoBaseName: 'ШУ33', headDeviceName: 'ЩР1', power: 2.0599999999999996 },
      { rowId: 41, nmoBaseName: 'Дв3331', headDeviceName: 'ШУ33', power: 1 },
      { rowId: 42, nmoBaseName: 'Дв3332', headDeviceName: 'ШУ33', power: 1 },
      { rowId: 43, nmoBaseName: 'ШУ1345', headDeviceName: 'ЩР1', power: 2 },
      { rowId: 44, nmoBaseName: 'ЯУ1345', headDeviceName: 'ШУ1345', power: 2 },
      { rowId: 45, nmoBaseName: 'Дв1345', headDeviceName: 'ЯУ1345', power: 1 },
      { rowId: 46, nmoBaseName: 'Дв2345', headDeviceName: 'ЯУ1345', power: 1 },
      { rowId: 47, nmoBaseName: 'ШУ15678', headDeviceName: 'ЩР1', power: 2 },
      { rowId: 48, nmoBaseName: 'ЯУ15678', headDeviceName: 'ШУ15678', power: 2 },
      { rowId: 49, nmoBaseName: 'Дв15678', headDeviceName: 'ЯУ15678', power: 1 },
      { rowId: 50, nmoBaseName: 'Дв25678', headDeviceName: 'ЯУ15678', power: 1 },
      { rowId: 51, nmoBaseName: 'EL7', headDeviceName: 'ШУ33', power: 0.03 },
      { rowId: 52, nmoBaseName: 'EL5', headDeviceName: 'ШУ33', power: 0.03 }
    ];

    function runFinalTest() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div>Running final test...</div>';
      
      const deviceMap = PowerCalculator.createDeviceMap(issueData);
      const childrenMap = PowerCalculator.createChildrenMap(issueData);
      
      let output = '<h2>Final Test Results</h2>';
      
      // Check for duplicates
      const nameCounts = {};
      issueData.forEach(device => {
        nameCounts[device.nmoBaseName] = (nameCounts[device.nmoBaseName] || 0) + 1;
      });
      
      const duplicates = Object.entries(nameCounts).filter(([name, count]) => count > 1);
      if (duplicates.length > 0) {
        output += '<div class="warning">⚠️ Duplicate names detected (first one kept):</div>';
        duplicates.forEach(([name, count]) => {
          output += `<p>${name}: ${count} devices</p>`;
        });
      }
      
      // Test the fixed algorithm
      const updates = PowerCalculator.calculateAllPowers(issueData);
      
      output += `<h3>Algorithm Updates: ${updates.length}</h3>`;
      
      // Map updates by rowId
      const updateMap = new Map();
      updates.forEach(update => {
        updateMap.set(update.rowId, update.power);
      });
      
      // Focus on key problem devices
      const problemDevices = ['ЩР1', 'ШУ1', 'ШУ33', 'ВРУ1', 'ВРУ2'];
      
      output += '<table><tr><th>RowId</th><th>Device</th><th>Current Power</th><th>New Power</th><th>Expected</th><th>Status</th></tr>';
      
      problemDevices.forEach(deviceName => {
        const devices = issueData.filter(d => d.nmoBaseName === deviceName);
        devices.forEach(device => {
          const currentPower = parseFloat(device.power) || 0;
          const newPower = updateMap.get(device.rowId);
          let expected = '';
          let status = '';
          let rowClass = '';
          
          if (deviceName === 'ЩР1') {
            expected = 'Should NOT change (has existing power > 0)';
            if (!newPower) {
              status = '✅ Correct';
            } else {
              status = '❌ Should not update';
            }
          } else if (deviceName === 'ШУ1') {
            expected = '6.18 (user expectation)';
            if (!newPower) {
              status = '✅ Correct (no update)';
            } else {
              status = '❌ Should not update';
            }
          } else if (deviceName === 'ШУ33') {
            expected = '2.06 (rounded)';
            if (newPower && Math.abs(newPower - 2.06) < 0.001) {
              status = '✅ Correct';
              rowClass = 'highlight';
            } else if (newPower) {
              status = `❌ Got ${newPower.toFixed(3)}`;
            } else {
              status = '❌ No update';
            }
          } else if (deviceName === 'ВРУ1' || deviceName === 'ВРУ2') {
            expected = 'Should NOT change (has existing power > 0)';
            if (!newPower) {
              status = '✅ Correct';
            } else {
              status = '❌ Should not update';
            }
          }
          
          output += `<tr class="${rowClass}">
            <td>${device.rowId}</td>
            <td>${device.nmoBaseName}</td>
            <td>${currentPower.toFixed(3)}</td>
            <td>${newPower ? newPower.toFixed(3) : 'No update'}</td>
            <td>${expected}</td>
            <td>${status}</td>
          </tr>`;
        });
      });
      
      output += '</table>';
      
      // Manual calculation verification for ШУ33
      output += '<h3>Manual Verification for ШУ33:</h3>';
      const shU33Device = issueData.find(d => d.nmoBaseName === 'ШУ33');
      const shU33Children = issueData.filter(d => d.headDeviceName === 'ШУ33');
      let manualShU33 = 0;
      shU33Children.forEach(child => {
        manualShU33 += parseFloat(child.power) || 0;
        output += `<p>${child.nmoBaseName}: ${child.power}</p>`;
      });
      output += `<p><strong>Manual sum: ${manualShU33.toFixed(3)}</strong></p>`;
      
      const calculatedShU33 = PowerCalculator.calculateDevicePower('ШУ33', childrenMap, deviceMap, new Set());
      output += `<p><strong>Algorithm result: ${calculatedShU33.toFixed(3)}</strong></p>`;
      
      resultsDiv.innerHTML = output;
    }
  </script>
</body>
</html>