<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Тесты Power Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .test-case {
      margin: 10px 0;
      padding: 10px;
      background: #f9f9f9;
      border-left: 4px solid #007cba;
    }
    .success {
      color: #28a745;
      font-weight: bold;
    }
    .error {
      color: #dc3545;
      font-weight: bold;
    }
    .result {
      margin: 10px 0;
      padding: 8px;
      border-radius: 4px;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Тесты модуля расчёта мощностей</h1>
    
    <div class="test-section">
      <h2>Тестирование PowerCalculator</h2>
      <button onclick="runAllTests()">Запустить все тесты</button>
      <div id="test-results"></div>
    </div>
  </div>

  <!-- Подключение модулей -->
  <script src="../widget/managerCalc/js/powerCalculator.js"></script>

  <script>
    // Тестовые данные из примера в issue
    const testDevices = [
      { rowId: 1, nmoBaseName: 'ЩР', headDeviceName: 'ВРУ1', power: 0 },
      { rowId: 2, nmoBaseName: 'EL5', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 3, nmoBaseName: 'EL7', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 4, nmoBaseName: 'EL5', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 5, nmoBaseName: 'EL6', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 6, nmoBaseName: 'Вкл', headDeviceName: 'ЩР', power: 0 },
      { rowId: 7, nmoBaseName: 'ЩР1', headDeviceName: 'ВРУ1', power: 0 },
      { rowId: 8, nmoBaseName: 'ЩР1', headDeviceName: 'ВРУ2', power: 0 },
      { rowId: 9, nmoBaseName: 'EL1', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 10, nmoBaseName: 'EL3', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 11, nmoBaseName: 'EL1', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 12, nmoBaseName: 'EL2', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 13, nmoBaseName: 'Вкл', headDeviceName: 'ЩР1', power: 0 },
      { rowId: 14, nmoBaseName: 'ВРУ1', headDeviceName: '???', power: 0 },
      { rowId: 15, nmoBaseName: 'ВРУ2', headDeviceName: '???', power: 0 }
    ];

    function runAllTests() {
      const resultsDiv = document.getElementById('test-results');
      resultsDiv.innerHTML = '<div class="result">Запуск тестов...</div>';
      
      try {
        testBasicFunctionality();
        testValidation();
        testHierarchyStats();
        testComplexHierarchy();
        
        resultsDiv.innerHTML += '<div class="result success">✅ Все тесты завершены</div>';
      } catch (error) {
        resultsDiv.innerHTML += `<div class="result error">❌ Ошибка: ${error.message}</div>`;
      }
    }

    function testBasicFunctionality() {
      console.log('Тест: Базовая функциональность');
      const resultsDiv = document.getElementById('test-results');
      
      // Проверяем создание словарей
      const deviceMap = PowerCalculator.createDeviceMap(testDevices);
      const childrenMap = PowerCalculator.createChildrenMap(testDevices);
      
      let testResult = '<div class="test-case"><h3>Базовая функциональность</h3>';
      
      // Проверяем количество устройств
      if (deviceMap.size === 15) {
        testResult += '<div class="success">✅ Словарь устройств создан корректно</div>';
      } else {
        testResult += '<div class="error">❌ Ошибка в словаре устройств</div>';
      }
      
      // Проверяем дочерние устройства
      const shRChildren = childrenMap.get('ЩР');
      if (shRChildren && shRChildren.length === 5) {
        testResult += '<div class="success">✅ Дочерние устройства ЩР определены корректно</div>';
      } else {
        testResult += '<div class="error">❌ Ошибка в дочерних устройствах ЩР</div>';
      }
      
      // Проверяем расчёт мощности для ЩР
      const shRPower = PowerCalculator.calculateDevicePower('ЩР', childrenMap, deviceMap, new Set());
      if (Math.abs(shRPower - 0.12) < 0.001) {
        testResult += '<div class="success">✅ Мощность ЩР рассчитана корректно (0.12)</div>';
      } else {
        testResult += `<div class="error">❌ Ошибка в мощности ЩР: ожидается 0.12, получено ${shRPower}</div>`;
      }
      
      testResult += '</div>';
      resultsDiv.innerHTML += testResult;
    }

    function testValidation() {
      console.log('Тест: Валидация данных');
      const resultsDiv = document.getElementById('test-results');
      
      let testResult = '<div class="test-case"><h3>Валидация данных</h3>';
      
      // Тест корректных данных
      const validValidation = PowerCalculator.validateData(testDevices);
      if (validValidation.isValid) {
        testResult += '<div class="success">✅ Валидация корректных данных прошла</div>';
      } else {
        testResult += '<div class="error">❌ Валидация корректных данных провалена</div>';
      }
      
      // Тест данных с ошибками
      const invalidDevices = [
        { rowId: 1, nmoBaseName: '', headDeviceName: 'ВРУ1', power: -5 },
        { rowId: 2, nmoBaseName: 'EL5', headDeviceName: 'ЩР', power: 'некорректное' }
      ];
      const invalidValidation = PowerCalculator.validateData(invalidDevices);
      if (!invalidValidation.isValid && invalidValidation.errors.length > 0) {
        testResult += '<div class="success">✅ Валидация некорректных данных обнаружила ошибки</div>';
        testResult += `<pre>Ошибки: ${invalidValidation.errors.join('; ')}</pre>`;
      } else {
        testResult += '<div class="error">❌ Валидация не обнаружила ошибки в некорректных данных</div>';
      }
      
      testResult += '</div>';
      resultsDiv.innerHTML += testResult;
    }

    function testHierarchyStats() {
      console.log('Тест: Статистика иерархии');
      const resultsDiv = document.getElementById('test-results');
      
      let testResult = '<div class="test-case"><h3>Статистика иерархии</h3>';
      
      const stats = PowerCalculator.getHierarchyStats(testDevices);
      
      if (stats.totalDevices === 15) {
        testResult += '<div class="success">✅ Общее количество устройств корректно</div>';
      } else {
        testResult += `<div class="error">❌ Ошибка в общем количестве устройств: ожидается 15, получено ${stats.totalDevices}</div>`;
      }
      
      if (stats.rootDevicesCount === 2) {
        testResult += '<div class="success">✅ Количество корневых устройств корректно</div>';
      } else {
        testResult += `<div class="error">❌ Ошибка в количестве корневых устройств: ожидается 2, получено ${stats.rootDevicesCount}</div>`;
      }
      
      testResult += `<pre>Статистика: ${JSON.stringify(stats, null, 2)}</pre>`;
      testResult += '</div>';
      resultsDiv.innerHTML += testResult;
    }

    function testComplexHierarchy() {
      console.log('Тест: Сложная иерархия');
      const resultsDiv = document.getElementById('test-results');
      
      let testResult = '<div class="test-case"><h3>Сложная иерархия</h3>';
      
      // Проверяем полное расчёта мощностей
      const updates = PowerCalculator.calculateAllPowers(testDevices);
      
      // Проверяем обновление для ВРУ1
      const vru1Update = updates.find(u => {
        const device = testDevices.find(d => d.rowId === u.rowId);
        return device && device.nmoBaseName === 'ВРУ1';
      });
      
      if (vru1Update && Math.abs(vru1Update.power - 0.24) < 0.001) {
        testResult += '<div class="success">✅ Мощность ВРУ1 рассчитана корректно (0.24)</div>';
      } else {
        testResult += `<div class="error">❌ Ошибка в мощности ВРУ1: ожидается 0.24</div>`;
      }
      
      // Проверяем обновление для ВРУ2
      const vru2Update = updates.find(u => {
        const device = testDevices.find(d => d.rowId === u.rowId);
        return device && device.nmoBaseName === 'ВРУ2';
      });
      
      if (vru2Update && Math.abs(vru2Update.power - 0.12) < 0.001) {
        testResult += '<div class="success">✅ Мощность ВРУ2 рассчитана корректно (0.12)</div>';
      } else {
        testResult += `<div class="error">❌ Ошибка в мощности ВРУ2: ожидается 0.12</div>`;
      }
      
      testResult += `<pre>Обновлений: ${updates.length}</pre>`;
      testResult += '</div>';
      resultsDiv.innerHTML += testResult;
    }

    // Автоматический запуск тестов при загрузке страницы
    window.addEventListener('load', function() {
      setTimeout(runAllTests, 100);
    });
  </script>
</body>
</html>