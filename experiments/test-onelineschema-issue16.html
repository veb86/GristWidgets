<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Direct Children Only Logic</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; }
    .success { color: #28a745; font-weight: bold; }
    .error { color: #dc3545; font-weight: bold; }
    .warning { color: #856404; font-weight: bold; }
    pre { background: #f8f9fa; padding: 10px; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .highlight { background-color: #fff3cd; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Test Direct Children Only Logic</h1>
    <button onclick="testDirectChildren()">Test Direct Children Logic</button>
    <div id="results"></div>
  </div>

  <script src="../widget/managerCalc/js/powerCalculator.js"></script>

  <script>
    // Test data matching the original example in issue
    const exampleData = [
      { rowId: 1, nmoBaseName: 'ЩР', headDeviceName: 'ВРУ1', power: 0 },
      { rowId: 2, nmoBaseName: 'EL5', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 3, nmoBaseName: 'EL7', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 4, nmoBaseName: 'EL5', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 5, nmoBaseName: 'EL6', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 6, nmoBaseName: 'Вкл', headDeviceName: 'ЩР', power: 0 },
      { rowId: 7, nmoBaseName: 'ЩР1', headDeviceName: 'ВРУ1', power: 0 },
      { rowId: 8, nmoBaseName: 'ЩР1', headDeviceName: 'ВРУ2', power: 0 },
      { rowId: 9, nmoBaseName: 'EL1', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 10, nmoBaseName: 'EL3', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 11, nmoBaseName: 'EL1', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 12, nmoBaseName: 'EL2', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 13, nmoBaseName: 'Вкл', headDeviceName: 'ЩР1', power: 0 },
      { rowId: 14, nmoBaseName: 'ВРУ1', headDeviceName: '???', power: 0 },
      { rowId: 15, nmoBaseName: 'ВРУ2', headDeviceName: '???', power: 0 }
    ];

    function testDirectChildren() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div>Testing direct children logic...</div>';
      
      const deviceMap = PowerCalculator.createDeviceMap(exampleData);
      const childrenMap = PowerCalculator.createChildrenMap(exampleData);
      
      let output = '<h2>Direct Children Only Test Results</h2>';
      
      // Test calculation for ЩР
      output += '<h3>Test 1: ЩР Calculation</h3>';
      const shRPower = PowerCalculator.calculateDevicePower('ЩР', childrenMap, deviceMap);
      output += `<p>ЩР direct children: ${childrenMap.get('ЩР').length}</p>`;
      
      childrenMap.get('ЩР').forEach(child => {
        output += `<p>- ${child.nmoBaseName}: ${child.power}</p>`;
      });
      output += `<p><strong>Expected: 0.12, Got: ${shRPower.toFixed(3)}</strong></p>`;
      
      if (Math.abs(shRPower - 0.12) < 0.001) {
        output += '<p class="success">✅ ЩР calculation correct!</p>';
      } else {
        output += '<p class="error">❌ ЩР calculation wrong!</p>';
      }
      
      // Test calculation for ЩР1
      output += '<h3>Test 2: ЩР1 Calculation</h3>';
      const shR1Power = PowerCalculator.calculateDevicePower('ЩР1', childrenMap, deviceMap);
      output += `<p>ЩР1 direct children: ${childrenMap.get('ЩР1').length}</p>`;
      
      childrenMap.get('ЩР1').forEach(child => {
        output += `<p>- ${child.nmoBaseName}: ${child.power}</p>`;
      });
      output += `<p><strong>Expected: 0.12, Got: ${shR1Power.toFixed(3)}</strong></p>`;
      
      if (Math.abs(shR1Power - 0.12) < 0.001) {
        output += '<p class="success">✅ ЩР1 calculation correct!</p>';
      } else {
        output += '<p class="error">❌ ЩР1 calculation wrong!</p>';
      }
      
      // Test calculation for ВРУ1
      output += '<h3>Test 3: ВРУ1 Calculation</h3>';
      const vru1Power = PowerCalculator.calculateDevicePower('ВРУ1', childrenMap, deviceMap);
      output += `<p>ВРУ1 direct children: ${childrenMap.get('ВРУ1').length}</p>`;
      
      childrenMap.get('ВРУ1').forEach(child => {
        output += `<p>- ${child.nmoBaseName}: ${child.power}</p>`;
      });
      output += `<p><strong>Expected: 0.24, Got: ${vru1Power.toFixed(3)}</strong></p>`;
      
      if (Math.abs(vru1Power - 0.24) < 0.001) {
        output += '<p class="success">✅ ВРУ1 calculation correct!</p>';
      } else {
        output += '<p class="error">❌ ВРУ1 calculation wrong!</p>';
      }
      
      // Test full algorithm
      output += '<h3>Test 4: Full Algorithm</h3>';
      const updates = PowerCalculator.calculateAllPowers(exampleData);
      output += `<p>Total updates: ${updates.length}</p>`;
      
      output += '<table><tr><th>RowId</th><th>Device</th><th>Old Power</th><th>New Power</th><th>Expected</th></tr>';
      
      // Map updates by rowId
      const updateMap = new Map();
      updates.forEach(update => {
        updateMap.set(update.rowId, update.power);
      });
      
      const expectedResults = {
        1: 0.12,  // ЩР
        7: 0.12,  // ЩР1 (ВРУ1)
        8: 0.12,  // ЩР1 (ВРУ2) 
        14: 0.24, // ВРУ1
        15: 0.24  // ВРУ2
      };
      
      exampleData.forEach(device => {
        const newPower = updateMap.get(device.rowId);
        const expected = expectedResults[device.rowId];
        
        if (expected !== undefined) {
          const oldPower = parseFloat(device.power) || 0;
          const status = (newPower && Math.abs(newPower - expected) < 0.001) ? '✅' : '❌';
          
          output += `<tr>
            <td>${device.rowId}</td>
            <td>${device.nmoBaseName}</td>
            <td>${oldPower}</td>
            <td>${newPower ? newPower.toFixed(3) : 'No update'}</td>
            <td>${expected}</td>
            <td>${status}</td>
          </tr>`;
        }
      });
      
      output += '</table>';
      
      resultsDiv.innerHTML = output;
    }
  </script>
</body>
</html>