<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Power Calculator Fix Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; }
    .success { color: #28a745; font-weight: bold; }
    .error { color: #dc3545; font-weight: bold; }
    .warning { color: #856404; font-weight: bold; }
    pre { background: #f8f9fa; padding: 10px; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Test Power Calculator Fix</h1>
    <button onclick="testPowerCalculator()">Test Fixed Algorithm</button>
    <div id="results"></div>
  </div>

  <script src="../widget/managerCalc/js/powerCalculator.js"></script>

  <script>
    // Test data from the issue
    const testData = [
      { rowId: 1, nmoBaseName: 'ЩР', headDeviceName: 'ВРУ1', power: 0 },
      { rowId: 2, nmoBaseName: 'EL5', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 3, nmoBaseName: 'EL7', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 4, nmoBaseName: 'EL5', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 5, nmoBaseName: 'EL6', headDeviceName: 'ЩР', power: 0.03 },
      { rowId: 6, nmoBaseName: 'Вкл', headDeviceName: 'ЩР', power: 0 },
      { rowId: 7, nmoBaseName: 'ЩР1', headDeviceName: 'ВРУ1', power: 0 },  // Duplicate name!
      { rowId: 8, nmoBaseName: 'ЩР1', headDeviceName: 'ВРУ2', power: 0 },  // Duplicate name!
      { rowId: 9, nmoBaseName: 'EL1', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 10, nmoBaseName: 'EL3', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 11, nmoBaseName: 'EL1', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 12, nmoBaseName: 'EL2', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 13, nmoBaseName: 'Вкл', headDeviceName: 'ЩР1', power: 0 },
      { rowId: 14, nmoBaseName: 'ВРУ1', headDeviceName: '???', power: 0 },
      { rowId: 15, nmoBaseName: 'ВРУ2', headDeviceName: '???', power: 0 },
      { rowId: 16, nmoBaseName: 'EL1', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 17, nmoBaseName: 'EL1', headDeviceName: 'ЩР1', power: 0.03 },
      { rowId: 18, nmoBaseName: 'ШУ1', headDeviceName: 'ЩР1', power: 6.240000000000002 },
      { rowId: 19, nmoBaseName: 'ЯУ1', headDeviceName: 'ШУ1', power: 2 },
      { rowId: 20, nmoBaseName: 'Дв1', headDeviceName: 'ЯУ1', power: 1 },
      { rowId: 21, nmoBaseName: 'Дв2', headDeviceName: 'ЯУ1', power: 1 },
      { rowId: 22, nmoBaseName: 'ШУ2', headDeviceName: 'ЩР1', power: 2 },
      { rowId: 23, nmoBaseName: 'ЯУ2', headDeviceName: 'ШУ2', power: 2 },
      { rowId: 24, nmoBaseName: 'Дв3', headDeviceName: 'ЯУ2', power: 1 },
      { rowId: 25, nmoBaseName: 'Дв4', headDeviceName: 'ЯУ2', power: 1 },
      { rowId: 26, nmoBaseName: 'ЯУ3', headDeviceName: 'ШУ1', power: 2 },
      { rowId: 27, nmoBaseName: 'Дв5', headDeviceName: 'ЯУ3', power: 1 },
      { rowId: 28, nmoBaseName: 'Дв6', headDeviceName: 'ЯУ3', power: 1 },
      { rowId: 29, nmoBaseName: 'EL8', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 30, nmoBaseName: 'EL9', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 31, nmoBaseName: 'EL9', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 32, nmoBaseName: 'EL8', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 33, nmoBaseName: 'EL8', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 34, nmoBaseName: 'EL9', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 35, nmoBaseName: 'ЯУ77', headDeviceName: 'ШУ1', power: 2 },
      { rowId: 36, nmoBaseName: 'Дв771', headDeviceName: 'ЯУ77', power: 1 },
      { rowId: 37, nmoBaseName: 'Дв772', headDeviceName: 'ЯУ77', power: 1 },
      { rowId: 38, nmoBaseName: 'EL9', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 39, nmoBaseName: 'EL77', headDeviceName: 'ШУ1', power: 0.03 },
      { rowId: 40, nmoBaseName: 'ШУ33', headDeviceName: 'ЩР1', power: 2.0599999999999996 },
      { rowId: 41, nmoBaseName: 'Дв3331', headDeviceName: 'ШУ33', power: 1 },
      { rowId: 42, nmoBaseName: 'Дв3332', headDeviceName: 'ШУ33', power: 1 },
      { rowId: 43, nmoBaseName: 'ШУ1345', headDeviceName: 'ЩР1', power: 2 },
      { rowId: 44, nmoBaseName: 'ЯУ1345', headDeviceName: 'ШУ1345', power: 2 },
      { rowId: 45, nmoBaseName: 'Дв1345', headDeviceName: 'ЯУ1345', power: 1 },
      { rowId: 46, nmoBaseName: 'Дв2345', headDeviceName: 'ЯУ1345', power: 1 },
      { rowId: 47, nmoBaseName: 'ШУ15678', headDeviceName: 'ЩР1', power: 2 },
      { rowId: 48, nmoBaseName: 'ЯУ15678', headDeviceName: 'ШУ15678', power: 2 },
      { rowId: 49, nmoBaseName: 'Дв15678', headDeviceName: 'ЯУ15678', power: 1 },
      { rowId: 50, nmoBaseName: 'Дв25678', headDeviceName: 'ЯУ15678', power: 1 },
      { rowId: 51, nmoBaseName: 'EL7', headDeviceName: 'ШУ33', power: 0.03 },
      { rowId: 52, nmoBaseName: 'EL5', headDeviceName: 'ШУ33', power: 0.03 }
    ];

    function testPowerCalculator() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div>Testing...</div>';
      
      const deviceMap = PowerCalculator.createDeviceMap(testData);
      const childrenMap = PowerCalculator.createChildrenMap(testData);
      
      let output = '<h2>Power Calculator Test Results</h2>';
      
      // Check for duplicate device names
      const nameCounts = {};
      testData.forEach(device => {
        nameCounts[device.nmoBaseName] = (nameCounts[device.nmoBaseName] || 0) + 1;
      });
      
      const duplicates = Object.entries(nameCounts).filter(([name, count]) => count > 1);
      if (duplicates.length > 0) {
        output += '<div class="warning">⚠️ Duplicate device names found:</div>';
        duplicates.forEach(([name, count]) => {
          output += `<p>${name}: ${count} devices</p>`;
        });
      }
      
      // Test ШУ1
      const shU1Power = PowerCalculator.calculateDevicePower('ШУ1', childrenMap, deviceMap, new Set());
      output += `<h3>ШУ1: ${shU1Power.toFixed(3)} (expected: ~6.18)</h3>`;
      
      // Test ШУ33
      const shU33Power = PowerCalculator.calculateDevicePower('ШУ33', childrenMap, deviceMap, new Set());
      output += `<h3>ШУ33: ${shU33Power.toFixed(3)} (expected: ~2.06)</h3>`;
      
      // Test ЩР1 - this might be problematic due to duplicates
      const shR1Power = PowerCalculator.calculateDevicePower('ЩР1', childrenMap, deviceMap, new Set());
      output += `<h3>ЩР1: ${shR1Power.toFixed(3)} (currently showing 14.48 in issue)</h3>`;
      
      // Show full calculation results
      const updates = PowerCalculator.calculateAllPowers(testData);
      output += `<h3>Full Updates (${updates.length} devices):</h3>`;
      output += '<table><tr><th>RowId</th><th>Device</th><th>New Power</th></tr>';
      
      updates.forEach(update => {
        const device = testData.find(d => d.rowId === update.rowId);
        if (device) {
          output += `<tr>
            <td>${update.rowId}</td>
            <td>${device.nmoBaseName}</td>
            <td>${update.power.toFixed(3)}</td>
          </tr>`;
        }
      });
      output += '</table>';
      
      // Manual calculation for verification
      output += '<h3>Manual Calculation for ШУ33:</h3>';
      const shU33Device = testData.find(d => d.nmoBaseName === 'ШУ33');
      const shU33Children = childrenMap.get('ШУ33') || [];
      let manualShU33 = 0;
      shU33Children.forEach(child => {
        manualShU33 += parseFloat(child.power) || 0;
      });
      output += `<p>ШУ33 children: ${manualShU33.toFixed(3)}</p>`;
      output += `<p>Current power: ${shU33Device.power}</p>`;
      
      resultsDiv.innerHTML = output;
    }
  </script>
</body>
</html>