# Виджет managerCalc для Grist

## Назначение

Виджет **managerCalc** предназначен для автоматического расчёта иерархических путей устройств в таблице `AllDevice`.

## Возможности

- Автоматический расчёт полного пути (`fullpath`) через всю иерархию устройств
- Расчёт пути только через головные устройства (`onlyGUpath`)
- Кэширование результатов для оптимизации производительности
- Валидация данных перед расчётом (проверка циклических зависимостей)
- Пакетное обновление записей для избежания перегрузки
- Индикатор прогресса выполнения операции

## Требования к таблице AllDevice

Таблица должна содержать следующие столбцы:

- `id` - уникальный идентификатор записи
- `deviceName` - название устройства
- `parentId` - ID родительского устройства (пусто для корневых элементов)
- `icanbeheadunit` - флаг, может ли устройство быть головным (boolean)
- `onlyGUpath` - путь через головные устройства (заполняется виджетом)
- `fullpath` - полный путь через все устройства (заполняется виджетом)

## Использование

1. Откройте документ Grist с таблицей `AllDevice`
2. Добавьте виджет **managerCalc** на страницу
3. Нажмите кнопку "Пересчитать пути устройств"
4. Дождитесь завершения расчёта

## Логика работы

### Расчёт fullpath

Полный путь строится рекурсивно от устройства до корня иерархии:

```
ВРУ → ГРЩ → ЩР → МФУ
fullpath для МФУ: "ВРУ\ГРЩ\ЩР\МФУ"
```

### Расчёт onlyGUpath

Путь через головные устройства включает только те устройства, у которых `icanbeheadunit = true`:

```
ВРУ (✅) → ГРЩ (✅) → ЩР (❌) → МФУ (❌)
onlyGUpath для МФУ: "ВРУ\ГРЩ"
```

## Архитектура

Виджет состоит из модулей:

- **config.js** - конфигурация и константы
- **data.js** - работа с данными Grist (загрузка и обновление)
- **pathCalculator.js** - основная логика расчёта путей
- **ui.js** - управление пользовательским интерфейсом
- **app.js** - главный модуль приложения

## Оптимизация

Виджет использует следующие оптимизации:

1. **Кэширование** - уже рассчитанные пути сохраняются в памяти
2. **Пакетное обновление** - записи обновляются группами по 50 штук
3. **Валидация** - проверка данных до начала расчёта
4. **Задержки** - небольшие паузы между пакетами для избежания перегрузки

## Тестирование

Для проверки логики расчёта используйте файл:
```
experiments/test-managerCalc-logic.html
```

Откройте его в браузере для запуска автоматических тестов.

## Разработка

Код соответствует стандарту оформления, описанному в `CLAUDE.md`:

- Модульная структура (каждый модуль < 300 строк)
- Русскоязычные комментарии
- Осмысленные названия функций и переменных
- Максимальная длина строки: 100 символов
- Отступы: 2 пробела
- Каждая функция < 30 строк

## Структура файлов

```
widget/managerCalc/
├── index.html          # Главная страница виджета
├── css/
│   └── style.css       # Стили интерфейса
├── js/
│   ├── config.js       # Конфигурация
│   ├── data.js         # Работа с данными
│   ├── pathCalculator.js # Логика расчёта путей
│   ├── ui.js           # Управление UI
│   └── app.js          # Главный модуль
└── README.md           # Документация
```

## Примечания

- Разделитель путей: обратный слэш `\`
- Кодировка: UTF-8
- Язык интерфейса: русский
