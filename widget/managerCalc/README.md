# Виджет managerCalc для Grist

## Назначение

Виджет **managerCalc** предназначен для автоматического расчёта иерархических путей устройств в таблице `AllDevice`.

## Возможности

- Автоматический расчёт полного пути (`fullpath`) через всю иерархию устройств
- Расчёт пути только через головные устройства (`onlyGUpath`)
- Расчёт мощностей родительских устройств на основе дочерних устройств
- Кэширование результатов для оптимизации производительности
- Валидация данных перед расчётом (проверка циклических зависимостей)
- Пакетное обновление записей для избежания перегрузки
- Индикатор прогресса выполнения операции

## Требования к таблице AllDevice

Таблица должна содержать следующие столбцы:

- `id` - уникальный идентификатор записи
- `deviceName` - название устройства
- `parentId` - ID родительского устройства (пусто для корневых элементов)
- `icanbeheadunit` - флаг, может ли устройство быть головным (boolean)
- `onlyGUpath` - путь через головные устройства (заполняется виджетом)
- `fullpath` - полный путь через все устройства (заполняется виджетом)
- `HeadDeviceName` - имя родительского устройства
- `NMO_BaseName` - базовое имя устройства для идентификации
- `Power` - мощность устройства (числовое значение)
- `NGHeadDevice` - NG головное устройство
- `level1`, `level2`, `level3` - уровни электрических групп (заполняются виджетом)

## Использование

1. Откройте документ Grist с таблицей `AllDevice`
2. Добавьте виджет **managerCalc** на страницу
3. Выберите нужную операцию:
   - **"Пересчитать пути устройств"** - рассчитывает иерархические пути
   - **"Заполнить электрические группы"** - определяет уровни групп
   - **"Рассчитать мощности устройств"** - суммирует мощности дочерних устройств
4. Дождитесь завершения расчёта

## Логика работы

### Расчёт fullpath

Полный путь строится рекурсивно от устройства до корня иерархии:

```
ВРУ → ГРЩ → ЩР → МФУ
fullpath для МФУ: "ВРУ\ГРЩ\ЩР\МФУ"
```

### Расчёт onlyGUpath

Путь через головные устройства включает только те устройства, у которых `icanbeheadunit = true`:

```
ВРУ (✅) → ГРЩ (✅) → ЩР (❌) → МФУ (❌)
onlyGUpath для МФУ: "ВРУ\ГРЩ"
```

### Расчёт мощностей

Мощность родительского устройства рассчитывается как сумма мощностей всех дочерних устройств на всех уровнях иерархии:

```
ВРУ (0) ← ВРУ1 (0.24) ← ЩР (0.12) ← EL5 (0.03)
                              ← EL7 (0.03)
                              ← EL6 (0.03)
                              ← Вкл (0)
```

Мощность ЩР = 0.03 + 0.03 + 0.03 + 0.03 = 0.12
Мощность ВРУ1 = 0.12 (от ЩР) + 0.12 (от ЩР1) = 0.24

## Архитектура

Виджет состоит из модулей:

- **config.js** - конфигурация и константы
- **data.js** - работа с данными Grist (загрузка и обновление)
- **pathCalculator.js** - основная логика расчёта путей
- **groupCalculator.js** - расчёт электрических групп
- **powerCalculator.js** - расчёт мощностей устройств
- **ui.js** - управление пользовательским интерфейсом
- **app.js** - главный модуль приложения

## Оптимизация

Виджет использует следующие оптимизации:

1. **Кэширование** - уже рассчитанные пути сохраняются в памяти
2. **Пакетное обновление** - записи обновляются группами по 50 штук
3. **Валидация** - проверка данных до начала расчёта
4. **Задержки** - небольшие паузы между пакетами для избежания перегрузки

## Тестирование

Для проверки логики расчёта используйте файлы:
```
experiments/test-managerCalc-logic.html    - тесты путей и групп
experiments/test-powerCalculator-logic.html - тесты расчёта мощностей
```

Откройте их в браузере для запуска автоматических тестов.

## Разработка

Код соответствует стандарту оформления, описанному в `CLAUDE.md`:

- Модульная структура (каждый модуль < 300 строк)
- Русскоязычные комментарии
- Осмысленные названия функций и переменных
- Максимальная длина строки: 100 символов
- Отступы: 2 пробела
- Каждая функция < 30 строк

## Структура файлов

```
widget/managerCalc/
├── index.html          # Главная страница виджета
├── css/
│   └── style.css       # Стили интерфейса
├── js/
│   ├── config.js       # Конфигурация
│   ├── data.js         # Работа с данными
│   ├── pathCalculator.js # Логика расчёта путей
│   ├── groupCalculator.js # Логика расчёта групп
│   ├── powerCalculator.js # Логика расчёта мощностей
│   ├── ui.js           # Управление UI
│   └── app.js          # Главный модуль
└── README.md           # Документация
```

## Примечания

- Разделитель путей: обратный слэш `\`
- Кодировка: UTF-8
- Язык интерфейса: русский
