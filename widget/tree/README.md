# Виджет "Дерево иерархии устройств" для Grist

## Описание

Управляющий виджет для построения иерархического дерева устройств из таблицы с возможностью фильтрации данных в связанных табличных виджетах.

## Основные возможности

### 1. Построение иерархии устройств

- **Фильтрация по флагу**: Включаются только устройства с `icanbeheadunit = 1`
- **Алгоритм**: Построение на основе ссылок родитель-ребенок через поле `HeadDeviceName`
- **Корневые элементы**: Автоматическое определение устройств без родителей
- **Защита от циклов**: Обработка циклических ссылок

### 2. Настраиваемая конфигурация

Доступна панель настроек (кнопка ⚙️ в правом верхнем углу):

- **Поле ID устройства** (по умолчанию: `NMO_BaseName`)
- **Поле родителя** (по умолчанию: `HeadDeviceName`)
- **Поле флага иерархии** (по умолчанию: `icanbeheadunit`)
- **Поле отображения** (по умолчанию: `NMO_BaseName`)

### 3. Фильтрация связанных виджетов

При выборе узла в дереве:
- Применяется фильтр к связанным табличным виджетам
- Фильтруются выбранное устройство и все его потомки
- Для корневого элемента - все устройства в поддереве
- Для листового узла - только выбранное устройство

### 4. Интерфейс пользователя

- **Древовидная структура** с иконками для папок и файлов
- **Автоматическое раскрытие** всех узлов по умолчанию
- **Статус-бар** с информацией о состоянии
- **Индикатор загрузки** при обработке данных

### 5. Обработка состояний

- **"Загрузка данных..."** - при получении данных из Grist
- **"Нет данных для отображения"** - если таблица пуста
- **"Нет устройств с флагом..."** - если нет устройств с `icanbeheadunit = 1`
- **Сообщения об ошибках** - при проблемах с данными

## Архитектура кода

Реализация следует стандартам кодирования из CLAUDE.md:

### Модульная структура

1. **ConfigModule** - Управление конфигурацией
   - Хранение настроек полей
   - Синхронизация с UI

2. **DataModule** - Работа с данными
   - Загрузка данных из Grist API
   - Преобразование формата данных

3. **HierarchyModule** - Построение иерархии
   - Фильтрация по флагу
   - Создание карты узлов
   - Установка связей родитель-ребенок
   - Поиск корневых элементов
   - Обработка циклических ссылок

4. **UIModule** - Отображение интерфейса
   - Инициализация дерева jsTree
   - Обновление дерева
   - Обработка выбора узлов
   - Управление статус-баром

5. **FilterModule** - Фильтрация данных
   - Применение фильтров к связанным виджетам
   - Сбор всех потомков узла

6. **AppController** - Главный контроллер
   - Инициализация приложения
   - Координация модулей
   - Обработка событий

### Принципы реализации

- ✅ Модули не превышают 300-500 строк
- ✅ Каждый модуль имеет одну чёткую ответственность
- ✅ Функции не превышают 30 строк
- ✅ Все комментарии на русском языке
- ✅ JSDoc для всех функций
- ✅ Отсутствие магических чисел
- ✅ DRY (Don't Repeat Yourself)

## Структура данных

### Требуемые поля таблицы Device

```
NMO_BaseName      - Идентификатор устройства (строка)
HeadDeviceName    - Ссылка на родительское устройство (строка, значение из NMO_BaseName родителя)
icanbeheadunit    - Флаг участия в иерархии (1 или 0)
```

### Пример данных

| id | NMO_BaseName | HeadDeviceName | icanbeheadunit |
|----|--------------|----------------|----------------|
| 1  | Device_A     | NULL           | 1              |
| 2  | Device_B     | Device_A       | 1              |
| 3  | Device_C     | Device_A       | 1              |
| 4  | Device_D     | Device_B       | 1              |
| 5  | Device_E     | Device_C       | 0              |

В этом примере:
- `Device_A` - корневой элемент
- `Device_B` и `Device_C` - дочерние для `Device_A`
- `Device_D` - дочерний для `Device_B`
- `Device_E` - не участвует в иерархии (icanbeheadunit = 0)

## Использование

### 1. Запуск сервера

```bash
python server.py
```

Сервер запустится на `http://localhost:3333`

### 2. Добавление виджета в Grist

1. Откройте документ Grist
2. Добавьте новый Custom Widget
3. Укажите URL: `http://localhost:3333/tree/index.html`
4. Выберите таблицу "Device" (или вашу таблицу с устройствами)
5. Настройте поля через кнопку ⚙️ Настройки

### 3. Настройка фильтрации

1. Добавьте табличные виджеты, которые нужно фильтровать
2. Настройте их для использования той же таблицы
3. При выборе узла в дереве фильтры применятся автоматически

## Технические детали

### Используемые библиотеки

- **jQuery 3.6.0** - DOM манипуляции
- **jsTree 3.3.12** - визуализация дерева
- **Grist Plugin API** - интеграция с Grist

### API Grist

```javascript
// Инициализация
grist.ready({ requiredAccess: 'read table' })

// Загрузка данных
grist.docApi.fetchSelectedTable()

// Навигация к записи
grist.setCursorPos({ rowId: recordId })

// Применение фильтра
grist.setSelectedRows(arrayOfIds)

// Обновление при изменении данных
grist.onRecords(callback)
```

### Алгоритм построения иерархии

1. **Фильтрация**: Отбор записей с `icanbeheadunit = 1`
2. **Создание карты**: Создание объектов узлов по идентификаторам
3. **Связывание**: Установка связей родитель-ребенок по `HeadDeviceName`
4. **Поиск корней**: Определение узлов без родителей
5. **Проверка циклов**: DFS для обнаружения циклических ссылок
6. **Рендеринг**: Рекурсивное построение визуального дерева

### Обработка ошибок

- Валидация структуры данных
- Проверка наличия обязательных полей
- Защита от некорректных ссылок
- Graceful degradation при отсутствии данных

## Примеры кастомизации

### Изменение полей по умолчанию

Отредактируйте в ConfigModule:

```javascript
var config = {
  idField: "DeviceID",           // вместо NMO_BaseName
  parentField: "ParentDevice",   // вместо HeadDeviceName
  flagField: "IsActive",         // вместо icanbeheadunit
  displayField: "DeviceName"     // отдельное поле для отображения
};
```

### Добавление дополнительной информации в узлы

Модифицируйте функцию `buildJsTreeNode` в UIModule:

```javascript
var jsTreeNode = {
  id: node.id.toString(),
  text: node.text + ' (' + node.data.additionalField + ')', // добавить доп. поле
  // ...
};
```

## Ограничения и известные проблемы

1. **Глубокая рекурсия**: Для очень глубоких деревьев (>100 уровней) может потребоваться оптимизация
2. **Большие объёмы данных**: При >10000 узлов рекомендуется ленивая загрузка
3. **Фильтрация**: Базовая версия фильтрует только прямых потомков, не всех рекурсивных

## Будущие улучшения

- [ ] Поиск по дереву
- [ ] Drag & drop для перестроения иерархии
- [ ] Контекстное меню узлов
- [ ] Экспорт дерева в различных форматах
- [ ] Кеширование для повышения производительности
- [ ] Настройка внешнего вида (темы, размер шрифта)
- [ ] Полная рекурсивная фильтрация потомков

## Лицензия

Проект распространяется в соответствии с лицензией основного репозитория veb86/GristWidgets.

## Авторы

- Исходная реализация: veb86
- Модульная архитектура и развитие функционала: Claude Sonnet 4.5 (AI ассистент)

## Контакты и поддержка

Для сообщений об ошибках и запросов новых функций используйте:
https://github.com/veb86/GristWidgets/issues
