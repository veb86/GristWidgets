<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Виджет-органайзер electricalCalc</title>
    <!-- Подключение стилей для виджета-органайзера -->
    <link rel="stylesheet" href="./css/style.css">
    
    <!-- Загрузка внешних библиотек -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css">
</head>
<body>
    <!-- Основной контейнер с flexbox-версткой для разделения экрана -->
    <!-- Делит интерфейс на левую панель (20%) и правую панель (80%) -->
    <div class="main-container">
        <!-- Левая панель (20%) - навигационное дерево устройств -->
        <div id="left-panel">
            <element-tree id="nav-tree"></element-tree>
        </div>

        <!-- Правая панель (80%) - рабочая область с вкладками -->
        <div id="right-panel">
            <!-- Система вкладок для переключения между виджетами -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="tab-edittable">Таблица</button>
                <button class="tab-btn" data-tab="tab-onelineschema">Однолинейная схема</button>
            </div>

            <!-- Контент вкладок - здесь размещаются Web Components -->
            <div class="tab-content">
                <!-- Панель с виджетом редактирования таблиц -->
                <div class="tab-pane active" id="tab-edittable">
                    <element-edit-table id="edit-table"></element-edit-table>
                </div>

                <!-- Панель с виджетом визуализации однолинейных схем -->
                <div class="tab-pane" id="tab-onelineschema">
                    <element-one-line-schema id="one-line-schema"></element-one-line-schema>
                </div>
            </div>
        </div>
    </div>

    <!-- Глобальный объект для API взаимодействия между компонентами -->
    <script>
        // Глобальный объект для API взаимодействия между компонентами
        window.AppHost = {
            subscribers: [],
            
            // Метод получения данных
            getData() {
                // Возвращаем данные из Grist API
                if (window.grist) {
                    return window.grist.getTable();
                }
                return null;
            },
            
            // Метод подписки на изменения данных
            subscribe(callback) {
                this.subscribers.push(callback);
                
                // Возвращаем функцию отписки
                return () => {
                    const index = this.subscribers.indexOf(callback);
                    if (index > -1) {
                        this.subscribers.splice(index, 1);
                    }
                };
            },
            
            // Метод отправки событий
            sendEvent(name, data) {
                // Отправляем событие через CustomEvent
                const event = new CustomEvent(name, { detail: data });
                document.dispatchEvent(event);
            },
            
            // Метод вызова подписчиков при изменении данных
            notifySubscribers(data) {
                this.subscribers.forEach(callback => {
                    try {
                        callback(data);
                    } catch (error) {
                        console.error('Error in subscriber callback:', error);
                    }
                });
            },
            
            // Метод для установки выбранных строк
            setSelectedRows(rowIds) {
                if (window.grist) {
                    window.grist.setSelectedRows(rowIds);
                }
            },
            
            // Метод для установки позиции курсора
            setCursorPos(pos) {
                if (window.grist) {
                    window.grist.setCursorPos(pos);
                }
            }
        };
        
        // Обработка сообщений от Grist API
        if (window.grist) {
            window.grist.ready();
            window.grist.onRecords(function(records) {
                window.AppHost.notifySubscribers({ type: 'records', data: records });
            });
        }
    </script>

    <!-- Определение Web Components -->
    <script src="./js/element-tree.js"></script>
    <script src="./js/element-edit-table.js"></script>
    <script src="./js/element-one-line-schema.js"></script>
    
    <!-- Модуль управления вкладками - обеспечивает переключение между вкладками -->
    <script src="./js/tabs.js"></script>
</body>
</html>