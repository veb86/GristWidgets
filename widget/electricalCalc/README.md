# Виджет-органайзер electricalCalc (Web Components)

## Описание

Виджет-органайзер `electricalCalc` переработан для использования современной архитектуры на основе Web Components. Это решает проблему с вложенными iframe, которые не работают корректно с Grist API. Теперь все компоненты взаимодействуют через единый API уровень, обеспечивая полную функциональность даже в сложных сценариях.

## Новая архитектура

### Web Components + Явный API уровень

В отличие от старой версии с вложенными iframe, теперь используется:

- **Web Components** для изоляции и переиспользования компонентов
- **Явный API уровень** через глобальный объект `window.AppHost`
- **Событийная модель** для взаимодействия между компонентами
- **Shadow DOM** для изоляции стилей

### Структура интерфейса

Интерфейс разделен на две основные части:

- **Левая панель (20%)** - навигационное дерево устройств (`<element-tree>`)
- **Правая панель (80%)** - рабочая область с вкладками

### Вкладки правой панели

1. **Таблица** - виджет `<element-edit-table>` для редактирования данных
2. **Однолинейная схема** - виджет `<element-one-line-schema>` для визуализации схем

## Техническая реализация

### HTML структура

Используется семантическая HTML5 разметка с Web Components:

```html
<div class="main-container">
    <div id="left-panel">
        <element-tree id="nav-tree"></element-tree>
    </div>
    <div id="right-panel">
        <div class="tabs">
            <!-- Кнопки вкладок -->
        </div>
        <div class="tab-content">
            <!-- Панели с Web Components -->
            <element-edit-table id="edit-table"></element-edit-table>
            <element-one-line-schema id="one-line-schema"></element-one-line-schema>
        </div>
    </div>
</div>
```

### API взаимодействия

Глобальный объект `window.AppHost` предоставляет следующие методы:

- `getData()` - получение данных из Grist
- `subscribe(callback)` - подписка на изменения данных
- `sendEvent(name, data)` - отправка событий между компонентами
- `setSelectedRows(rowIds)` - установка выбранных строк
- `setCursorPos(pos)` - установка позиции курсора

### CSS стили

- **Flexbox верстка** для адаптивного разделения экрана
- **Изоляция стилей** через Shadow DOM в компонентах
- **Адаптивность** для различных размеров экрана
- **Визуальное разделение** панелей с помощью границ и фонов

### JavaScript логика

Класс `TabManager` обеспечивает:

- Переключение между вкладками
- Клавиатурную навигацию (Ctrl+Tab, Ctrl+Shift+Tab)
- Обработку состояний активной вкладки
- Логирование действий для отладки

## Преимущества новой архитектуры

### ✅ Решение проблемы с вложенными iframe

- Grist API теперь доступен во всех компонентах
- Нет ограничений глубины вложенности
- Компоненты могут полноценно взаимодействовать с Grist

### ✅ Изоляция стилей

- Каждый компонент имеет собственный Shadow DOM
- Стили одного компонента не влияют на другие
- Легко интегрировать с другими частями приложения

### ✅ Улучшенная производительность

- Нет оверхеда от iframe
- Быстрее загрузка и отрисовка
- Эффективное управление памятью

### ✅ Упрощенная отладка

- Единая точка взаимодействия через AppHost
- Легче отслеживать поток данных
- Проще тестировать отдельные компоненты

## Файловая структура

```
electricalCalc/
├── index.html              # Основной HTML файл с Web Components
├── css/
│   └── style.css           # Стили виджета
├── js/
│   ├── element-tree.js     # Web Component для дерева
│   ├── element-edit-table.js # Web Component для таблицы
│   ├── element-one-line-schema.js # Web Component для схемы
│   └── tabs.js             # Логика управления вкладками
├── widget.json             # Конфигурация виджета
├── README.md               # Документация
└── test.js                 # Тесты для новой архитектуры
```

## Совместимость

- **Grist версии**: >= 1.0.0
- **Браузеры**: Chrome, Firefox, Safari, Edge (с поддержкой Web Components)
- **Разрешение**: адаптивный дизайн для мобильных и десктопных устройств

## Установка и использование

1. Скопировать директорию `electricalCalc` в папку `widget/`
2. Добавить виджет в Grist через интерфейс custom widgets
3. Настроить доступ к таблицам и данным через Grist API

## Тестирование

Для тестирования функциональности:

1. Открыть `index.html` в браузере
2. Проверить загрузку всех Web Components
3. Убедиться в корректной работе переключения вкладок
4. Проверить взаимодействие с Grist API через AppHost
5. Запустить автоматические тесты из `test.js`

## Разработка

При внесении изменений:

1. Следовать принципу изоляции через Web Components
2. Использовать AppHost для взаимодействия между компонентами
3. Не нарушать существующую функциональность
4. Добавлять комментарии на русском языке
5. Проверять совместимость с браузерами

## Лицензия

Код распространяется под той же лицензией, что и основной проект GristWidgets.