# Исправления BDControl Widget

## Что было исправлено

### 1. Проблема со сравнением типов (строка vs число)

**Проблема:** `selectedGroupID` из Grist приходит как строка `"5"`, а в `Group_Characteristics` `group_id` хранится как число `5`. Сравнение `===` не работало.

**Решение:** Добавлено приведение типов в функциях:
- `getCharacteristicsForGroup()` — преобразует `groupId` к числу
- `getCharacteristicValue()` — преобразует `deviceId` и `characteristicId` к числам

### 2. Проблема с порядком инициализации

**Проблема:** Tabulator инициализировался **до** загрузки данных, поэтому `currentCharacteristics` был пустым и колонки не создавались.

**Решение:** 
- Убрана ранняя инициализация Tabulator в `initializeUI()`
- Добавлена **ленивая инициализация** — Tabulator создаётся только при первой отрисовке в `render()`
- Характеристики загружаются **перед** отрисовкой в `onDataReady()`

### 3. Проблема с обновлением колонок Tabulator

**Проблема:** При смене группы Tabulator вызывал `setData()`, но колонки не обновлялись.

**Решение:** Добавлен вызов `tabulatorInstance.setColumns(columns)` перед `setData()` для пересоздания колонок.

### 4. Проблема с получением значений характеристик

**Проблема:** Проверка `value_float !== 0` блокировала возврат значения `0`.

**Решение:** Изменён порядок проверок:
1. Сначала `value_string` (строки не могут быть `0`)
2. Затем `value_float` (где `0` — валидное значение)
3. Затем `value_int`
4. Затем `value_bool`

## Изменённые файлы

| Файл | Изменения |
|------|-----------|
| `js/grist-api.js` | Исправлено сравнение типов, улучшена обработка значений |
| `js/ui.js` | Ленивая инициализация Tabulator, пересоздание колонок |
| `js/app.js` | Характеристики загружаются перед отрисовкой |

## Как проверить

### Шаг 1: Откройте виджет в Grist

1. Откройте ваш Grist документ
2. Перейдите на страницу с виджетом BDControl
3. Убедитесь что в таблице `SYSTEM` установлено `selectedGroupID = 4` или `5`

### Шаг 2: Проверьте консоль браузера

Нажмите `F12` → вкладка **Console**

Должны быть сообщения:
```
Инициализация виджета BDControl...
UI инициализирован (Tabulator будет создан при отрисовке)
Загрузка таблиц через docApi.fetchTable...
Device_groups: 6 записей
Device: 2 записей
SYSTEM: 1 записей
Group_Characteristics: 5 записей
Characteristics: 4 записей
Device_characteristics: 8 записей
[App] updateCharacteristicsForGroup, groupId: 5
[App] Характеристики для группы 5: [...]
[App] Количество характеристик: 3
BDControl Widget загружен: {groups: 6, devices: 2, selectedGroupId: 5}
```

### Шаг 3: Проверьте таблицу

Для `selectedGroupID = 5` (Лампы) должны быть столбцы:
- Наименование
- Модель
- Производитель
- Ед. изм.
- Количество
- Примечание
- Группа
- **Мощность (Вт)** ← характеристика
- **Световой поток (лм)** ← характеристика
- **Температура (К)** ← характеристика

Для `selectedGroupID = 4` (Светильники) должны быть столбцы:
- Наименование
- Модель
- Производитель
- Ед. изм.
- Количество
- Примечание
- Группа
- **Мощность (Вт)** ← характеристика
- **Световой поток (лм)** ← характеристика

### Шаг 4: Проверьте значения

Устройство 1 (Светильник, devgroup_id=4):
- Мощность: `40`
- Световой поток: `4200`

Устройство 2 (Лампа, devgroup_id=5):
- Мощность: `300`
- Световой поток: `12000`
- Температура: `7000`

## Если не работает

### Проверьте через минимальный тест

Откройте `minimal-test.html` в контексте Grist:
```
https://your-doc.getgrist.com/your-page/widget/BDControl/minimal-test.html
```

Убедитесь что:
- Все таблицы загрузились (> 0 записей)
- Характеристики для группы 4: 2 штуки
- Характеристики для группы 5: 3 штуки
- Значения для устройства 1 отображаются

### Проверьте маппинг виджета

В Grist нажмите на виджет → **Select Widget** → **Custom**

Убедитесь что:
- Виджет привязан к таблице `SYSTEM`
- URL виджета указывает на правильный `index.html`

### Очистите кэш браузера

Нажмите `Ctrl+Shift+R` (Windows) или `Cmd+Shift+R` (Mac) для полной перезагрузки страницы.

## Дополнительные тесты

### Тест 1: Смена группы

1. Установите `selectedGroupID = 4`
2. Запомните какие столбцы отображаются
3. Установите `selectedGroupID = 5`
4. Убедитесь что столбцы изменились (должно появиться "Температура")

### Тест 2: Проверка значений

1. Откройте консоль браузера
2. Выполните:
```javascript
// Проверка получения значения характеристики
var val = grist.docApi.fetchTable('Device_characteristics').then(d => {
  var data = d;
  console.log('Device_characteristics:', data);
});
```

### Тест 3: Проверка колонок

1. Откройте консоль браузера
2. Выполните:
```javascript
// Проверка что колонки создались
console.log('Tabulator columns:', document.querySelector('#devices-table')._tabulator.columns.length);
```

## Известные ограничения

1. **Пустые значения:** Если характеристика не заполнена для устройства, отображается пустая ячейка
2. **Типы данных:** Числовые значения `0` теперь отображаются корректно
3. **Сравнение ID:** Работает как для строк так и для чисел

## Будущие улучшения

- [ ] UI для управления видимостью столбцов
- [ ] Сохранение настроек пользователя
- [ ] Drag-and-drop для изменения порядка колонок
- [ ] Экспорт/импорт настроек
