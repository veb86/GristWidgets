<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BDControl - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    h2 { color: #666; margin-top: 20px; }
    .status {
      padding: 10px 15px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow: auto;
      max-height: 400px;
      font-size: 12px;
    }
    .btn {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    .btn:hover {
      background: #0056b3;
    }
    .btn-success {
      background: #28a745;
    }
    .btn-success:hover {
      background: #1e7e34;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü Grist</h1>
    
    <div id="status-container"></div>
    
    <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ</h2>
    <div id="tables-list"></div>
    
    <h2>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü</h2>
    <div id="tables-structure"></div>
    
    <h2>–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ BDControl</h2>
    <div id="widget-data"></div>
    
    <h2>–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
    <pre id="raw-data">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
  </div>

  <script src="./grist-plugin-api.js"></script>
  <script>
    async function checkTables() {
      const statusContainer = document.getElementById('status-container');
      const tablesListDiv = document.getElementById('tables-list');
      const tablesStructureDiv = document.getElementById('tables-structure');
      const widgetDataDiv = document.getElementById('widget-data');
      const rawDataPre = document.getElementById('raw-data');

      try {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        grist.ready({ requiredAccess: 'full' });

        // 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
        statusContainer.innerHTML = '<div class="status info">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–∞–±–ª–∏—Ü...</div>';
        
        const allTables = await grist.docApi.fetchTable('_grist_Tables');
        console.log('–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã:', allTables);

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü
        if (allTables && allTables.id && allTables.tableId) {
          let tablesHtml = '<table><thead><tr><th>ID</th><th>–ò–º—è —Ç–∞–±–ª–∏—Ü—ã</th></tr></thead><tbody>';
          
          for (let i = 0; i < allTables.id.length; i++) {
            const tableName = allTables.tableId[i];
            const tableId = allTables.id[i];
            tablesHtml += `<tr><td>${tableId}</td><td><strong>${tableName}</strong></td></tr>`;
          }
          
          tablesHtml += '</tbody></table>';
          tablesListDiv.innerHTML = tablesHtml;

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω—É–∂–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
          const requiredTables = ['device_groups', 'device', 'SYSTEM'];
          const availableTables = allTables.tableId || [];
          
          let checkHtml = '<div style="margin: 15px 0;">';
          requiredTables.forEach(tableName => {
            const exists = availableTables.includes(tableName);
            checkHtml += `<div class="status ${exists ? 'success' : 'error'}">`;
            checkHtml += `<strong>${tableName}:</strong> ${exists ? '‚úì –ù–∞–π–¥–µ–Ω–∞' : '‚úó –ù–µ –Ω–∞–π–¥–µ–Ω–∞'}`;
            checkHtml += `</div>`;
          });
          checkHtml += '</div>';
          statusContainer.innerHTML = checkHtml;

          // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –Ω—É–∂–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
          let widgetDataHtml = '<h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞</h3>';
          let rawData = {};

          for (const tableName of requiredTables) {
            try {
              widgetDataHtml += `<div class="status info">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã "${tableName}"...</div>`;
              widgetDataDiv.innerHTML = widgetDataHtml;

              const tableData = await grist.docApi.fetchTable(tableName);
              rawData[tableName] = tableData;

              const recordCount = tableData && tableData.id ? tableData.id.length : 0;
              const columns = tableData ? Object.keys(tableData).filter(k => k !== 'id') : [];

              widgetDataHtml += `<div class="status success">`;
              widgetDataHtml += `<strong>${tableName}:</strong> ${recordCount} –∑–∞–ø–∏—Å–µ–π, —Å—Ç–æ–ª–±—Ü—ã: ${columns.join(', ')}`;
              widgetDataHtml += `</div>`;
              widgetDataDiv.innerHTML = widgetDataHtml;

              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 –∑–∞–ø–∏—Å–∏
              if (recordCount > 0) {
                let previewHtml = `<h4>${tableName} (–ø–µ—Ä–≤—ã–µ 3 –∑–∞–ø–∏—Å–∏):</h4><table><thead><tr>`;
                
                columns.forEach(col => {
                  previewHtml += `<th>${col}</th>`;
                });
                
                previewHtml += '</tr></thead><tbody>';
                
                for (let i = 0; i < Math.min(3, recordCount); i++) {
                  previewHtml += '<tr>';
                  columns.forEach(col => {
                    previewHtml += `<td>${tableData[col][i] || ''}</td>`;
                  });
                  previewHtml += '</tr>';
                }
                
                previewHtml += '</tbody></table>';
                tablesStructureDiv.innerHTML += previewHtml;
              }

            } catch (error) {
              widgetDataHtml += `<div class="status error"><strong>${tableName}:</strong> –û—à–∏–±–∫–∞: ${error.message}</div>`;
              widgetDataDiv.innerHTML = widgetDataHtml;
              rawData[tableName] = { error: error.message };
            }
          }

          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
          rawDataPre.textContent = JSON.stringify(rawData, null, 2);

        } else {
          statusContainer.innerHTML = '<div class="status error">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü</div>';
        }

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        statusContainer.innerHTML = `<div class="status error">–û—à–∏–±–∫–∞: ${error.message}</div>`;
        rawDataPre.textContent = error.stack;
      }
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏
    checkTables();
  </script>
</body>
</html>
