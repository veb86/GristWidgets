# BDControl Widget - Динамические столбцы характеристик

## Обзор изменений

Виджет BDControl теперь поддерживает **динамическое отображение столбцов** в зависимости от выбранной группы устройств.

## Что изменилось

### 1. Новая таблица в БД: `Group_Characteristics`

Связывает группы устройств с их характеристиками и управляет видимостью столбцов.

**Структура:**
- `group_id` - ссылка на группу устройств
- `characteristic_id` - ссылка на характеристику
- `is_visible` - показывать ли столбец
- `sort_order` - порядок отображения столбца

### 2. Обновлённые файлы виджета

| Файл | Изменения |
|------|-----------|
| `js/grist-api.js` | Загрузка таблиц `Group_Characteristics`, `Characteristics`, `Device_characteristics`. Добавлены функции `getCharacteristicsForGroup()`, `getCharacteristicValue()` |
| `js/config.js` | Настройки видимости столбцов, конфигурация базовых колонок |
| `js/ui.js` | Динамическое формирование колонок Tabulator, отображение характеристик |
| `js/app.js` | Загрузка характеристик при смене группы |

### 3. Тестовый файл

`test-bdcontrol-widget.html` обновлён с тестовыми данными для проверки работы динамических столбцов.

## Пример работы

### Для группы "Светильники" (group_id = 4)

Отображаются столбцы:
- Наименование, Модель, Производитель, Ед. изм., Количество, Примечание, Группа (**базовые**)
- Мощность (Вт), Напряжение питания (В), Световой поток (лм), Температура (К) (**характеристики**)

### Для группы "Лампы" (group_id = 5)

Отображаются столбцы:
- Наименование, Модель, Производитель, Ед. изм., Количество, Примечание, Группа (**базовые**)
- Мощность (Вт), Световой поток (лм), Температура (К) (**характеристики**)

**Обратите внимание:** Столбец "Напряжение питания" не отображается для ламп, так как это не настроено в `Group_Characteristics`.

## Настройка в Grist

### Шаг 1: Создайте таблицу `Group_Characteristics`

1. В Grist создайте новую таблицу с именем `Group_Characteristics`
2. Добавьте поля:
   - `group_id` (Reference → `Device_groups`)
   - `characteristic_id` (Reference → `Characteristics`)
   - `is_visible` (Bool)
   - `sort_order` (Int)

### Шаг 2: Заполните данными

Импортируйте данные из файла `bd/Group_Characteristics.csv`

### Шаг 3: Настройте связи

Убедитесь что:
- `group_id` ссылается на существующие группы из `Device_groups`
- `characteristic_id` ссылается на существующие характеристики из `Characteristics`

### Шаг 4: Проверьте работу

1. Откройте виджет BDControl в Grist
2. Выберите группу устройств в таблице `SYSTEM` (параметр `selectedGroupID`)
3. Убедитесь что отображаются нужные столбцы характеристик

## Добавление новых характеристик для группы

1. **Создайте характеристику** в таблице `Characteristics`:
   ```
   code: "power_factor"
   name: "Коэффициент мощности"
   data_type: "float"
   unit: ""
   ```

2. **Добавьте связь** в `Group_Characteristics`:
   ```
   group_id: 4  (для светильников)
   characteristic_id: 5  (ID новой характеристики)
   is_visible: true
   sort_order: 5
   ```

3. **Заполните значения** для устройств в `Device_characteristics`:
   ```
   device_id: 1
   characteristic_id: 5
   value_float: 0.95
   ```

## Скрытие столбца

Чтобы скрыть столбец для группы, установите `is_visible = false` в таблице `Group_Characteristics`.

Пример: Скрыть "Температура" для ламп:
```
group_id: 5
characteristic_id: 4  (Температура)
is_visible: false
```

## Изменение порядка столбцов

Измените значение `sort_order` в таблице `Group_Characteristics`:
- Меньшие значения отображаются левее
- Столбцы с одинаковым `sort_order` сортируются по `id`

## Структура данных

```
┌─────────────────────────────────────────────────────────────┐
│  Device_groups                                              │
│  id | parent_id | code      | name                         │
│  4  | 1         | luminaires| Светильники                  │
│  5  | 1         | lamps     | Лампы                        │
└─────────────────────────────────────────────────────────────┘
                          ↓ group_id
┌─────────────────────────────────────────────────────────────┐
│  Group_Characteristics                                      │
│  id | group_id | characteristic_id | is_visible | sort_order│
│  1  | 4        | 1                 | true       | 1         │
│  2  | 4        | 3                 | true       | 2         │
└─────────────────────────────────────────────────────────────┘
                          ↓ characteristic_id
┌─────────────────────────────────────────────────────────────┐
│  Characteristics                                            │
│  id | code      | name           | data_type | unit        │
│  1  | power     | Мощность       | float     | Вт          │
│  3  | luminous_ | Световой поток | integer   | лм          │
│     | flux      |                |           |             │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│  Device_characteristics                                     │
│  id | device_id | characteristic_id | value_float | ...    │
│  1  | 1         | 1                 | 40          |        │
│  3  | 1         | 3                 | 4200        |        │
└─────────────────────────────────────────────────────────────┘
```

## Отладка

### Проверка в консоли браузера

Виджет выводит в консоль:
- Количество загруженных записей по каждой таблице
- Характеристики для выбранной группы
- Ошибки загрузки данных

### Пример вывода консоли

```
Group_Characteristics: 7 записей
Characteristics: 4 записей
Device_characteristics: 8 записей
Характеристики для группы 4: [
  {code: "power", name: "Мощность", unit: "Вт", ...},
  {code: "voltage", name: "Напряжение питания", unit: "В", ...},
  ...
]
```

## Будущие улучшения

Планируемые функции:
- [ ] UI для управления видимостью столбцов из виджета
- [ ] Drag-and-drop для изменения порядка столбцов
- [ ] Сохранение пользовательских настроек видимости
- [ ] Экспорт настроек между документами Grist
